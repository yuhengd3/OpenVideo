(()=>{var Pt=Object.defineProperty;var c=(X,g)=>Pt(X,"name",{value:g,configurable:!0});(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["vendors-node_modules_optimizely_optimizely-sdk_dist_optimizely_browser_es_min_js-node_modules-089adc"],{53949:(X,g,U)=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});var O=U(13196);function P(){return Math.round(Math.random()*1e3)}c(P,"randomMilliseconds");var C=function(){function T(){this.errorCount=0}return c(T,"BackoffController"),T.prototype.getDelay=function(){if(this.errorCount===0)return 0;var h=O.BACKOFF_BASE_WAIT_SECONDS_BY_ERROR_COUNT[Math.min(O.BACKOFF_BASE_WAIT_SECONDS_BY_ERROR_COUNT.length-1,this.errorCount)];return h*1e3+P()},T.prototype.countError=function(){this.errorCount<O.BACKOFF_BASE_WAIT_SECONDS_BY_ERROR_COUNT.length-1&&this.errorCount++},T.prototype.reset=function(){this.errorCount=0},T}();g.default=C},20731:function(X,g,U){"use strict";var O=this&&this.__extends||function(){var N=c(function(L,y){return N=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(v,M){v.__proto__=M}||function(v,M){for(var a in M)M.hasOwnProperty(a)&&(v[a]=M[a])},N(L,y)},"extendStatics");return function(L,y){N(L,y);function v(){this.constructor=L}c(v,"__"),L.prototype=y===null?Object.create(y):(v.prototype=y.prototype,new v)}}(),P=this&&this.__importDefault||function(N){return N&&N.__esModule?N:{default:N}};Object.defineProperty(g,"__esModule",{value:!0});var C=U(80064),T=P(U(20377)),h=function(N){O(L,N);function L(){return N!==null&&N.apply(this,arguments)||this}return c(L,"BrowserDatafileManager"),L.prototype.makeGetRequest=function(y,v){return C.makeGetRequest(y,v)},L.prototype.getConfigDefaults=function(){return{autoUpdate:!1}},L}(T.default);g.default=h},80064:(X,g,U)=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});var O=U(13196),P=U(98125),C=P.getLogger("DatafileManager"),T="GET",h=4;function N(v){var M=v.getAllResponseHeaders();if(M===null)return{};var a=M.split(`\r
`),E={};return a.forEach(function(u){var p=u.indexOf(": ");if(p>-1){var _=u.slice(0,p),I=u.slice(p+2);I.length>0&&(E[_]=I)}}),E}c(N,"parseHeadersFromXhr");function L(v,M){Object.keys(v).forEach(function(a){var E=v[a];M.setRequestHeader(a,E)})}c(L,"setHeadersInXhr");function y(v,M){var a=new XMLHttpRequest,E=new Promise(function(u,p){a.open(T,v,!0),L(M,a),a.onreadystatechange=function(){if(a.readyState===h){var _=a.status;if(_===0){p(new Error("Request error"));return}var I=N(a),F={statusCode:a.status,body:a.responseText,headers:I};u(F)}},a.timeout=O.REQUEST_TIMEOUT_MS,a.ontimeout=function(){C.error("Request timed out")},a.send()});return{responsePromise:E,abort:function(){a.abort()}}}c(y,"makeGetRequest"),g.makeGetRequest=y},13196:(X,g)=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0}),g.DEFAULT_UPDATE_INTERVAL=5*60*1e3,g.MIN_UPDATE_INTERVAL=1e3,g.DEFAULT_URL_TEMPLATE="https://cdn.optimizely.com/datafiles/%s.json",g.DEFAULT_AUTHENTICATED_URL_TEMPLATE="https://config.optimizely.com/datafiles/auth/%s.json",g.BACKOFF_BASE_WAIT_SECONDS_BY_ERROR_COUNT=[0,8,16,32,64,128,256,512],g.REQUEST_TIMEOUT_MS=60*1e3},10181:(X,g)=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});var U=function(){function O(){this.listeners={},this.listenerId=1}return c(O,"EventEmitter"),O.prototype.on=function(P,C){var T=this;this.listeners[P]||(this.listeners[P]={});var h=String(this.listenerId);return this.listenerId++,this.listeners[P][h]=C,function(){T.listeners[P]&&delete T.listeners[P][h]}},O.prototype.emit=function(P,C){var T=this.listeners[P];T&&Object.keys(T).forEach(function(h){var N=T[h];N(C)})},O.prototype.removeAllListeners=function(){this.listeners={}},O}();g.default=U},20377:function(X,g,U){"use strict";var O=this&&this.__assign||function(){return O=Object.assign||function(p){for(var _,I=1,F=arguments.length;I<F;I++){_=arguments[I];for(var b in _)Object.prototype.hasOwnProperty.call(_,b)&&(p[b]=_[b])}return p},O.apply(this,arguments)},P=this&&this.__importDefault||function(p){return p&&p.__esModule?p:{default:p}};Object.defineProperty(g,"__esModule",{value:!0});var C=U(98125),T=U(27378),h=P(U(10181)),N=U(13196),L=P(U(53949)),y=C.getLogger("DatafileManager"),v="update";function M(p){return p>=N.MIN_UPDATE_INTERVAL}c(M,"isValidUpdateInterval");function a(p){return p>=200&&p<400}c(a,"isSuccessStatusCode");var E={get:function(){return Promise.resolve("")},set:function(){return Promise.resolve()},contains:function(){return Promise.resolve(!1)},remove:function(){return Promise.resolve()}},u=function(){function p(_){var I=this,F=O(O({},this.getConfigDefaults()),_),b=F.datafile,A=F.autoUpdate,D=A===void 0?!1:A,k=F.sdkKey,Z=F.updateInterval,re=Z===void 0?N.DEFAULT_UPDATE_INTERVAL:Z,Ee=F.urlTemplate,ge=Ee===void 0?N.DEFAULT_URL_TEMPLATE:Ee,he=F.cache,Ne=he===void 0?E:he;this.cache=Ne,this.cacheKey="opt-datafile-"+k,this.isReadyPromiseSettled=!1,this.readyPromiseResolver=function(){},this.readyPromiseRejecter=function(){},this.readyPromise=new Promise(function(Oe,S){I.readyPromiseResolver=Oe,I.readyPromiseRejecter=S}),b?(this.currentDatafile=b,k||this.resolveReadyPromise()):this.currentDatafile="",this.isStarted=!1,this.datafileUrl=T.sprintf(ge,k),this.emitter=new h.default,this.autoUpdate=D,M(re)?this.updateInterval=re:(y.warn("Invalid updateInterval %s, defaulting to %s",re,N.DEFAULT_UPDATE_INTERVAL),this.updateInterval=N.DEFAULT_UPDATE_INTERVAL),this.currentTimeout=null,this.currentRequest=null,this.backoffController=new L.default,this.syncOnCurrentRequestComplete=!1}return c(p,"HttpPollingDatafileManager"),p.prototype.get=function(){return this.currentDatafile},p.prototype.start=function(){this.isStarted||(y.debug("Datafile manager started"),this.isStarted=!0,this.backoffController.reset(),this.setDatafileFromCacheIfAvailable(),this.syncDatafile())},p.prototype.stop=function(){return y.debug("Datafile manager stopped"),this.isStarted=!1,this.currentTimeout&&(clearTimeout(this.currentTimeout),this.currentTimeout=null),this.emitter.removeAllListeners(),this.currentRequest&&(this.currentRequest.abort(),this.currentRequest=null),Promise.resolve()},p.prototype.onReady=function(){return this.readyPromise},p.prototype.on=function(_,I){return this.emitter.on(_,I)},p.prototype.onRequestRejected=function(_){!this.isStarted||(this.backoffController.countError(),_ instanceof Error?y.error("Error fetching datafile: %s",_.message,_):typeof _=="string"?y.error("Error fetching datafile: %s",_):y.error("Error fetching datafile"))},p.prototype.onRequestResolved=function(_){if(!!this.isStarted){typeof _.statusCode<"u"&&a(_.statusCode)?this.backoffController.reset():this.backoffController.countError(),this.trySavingLastModified(_.headers);var I=this.getNextDatafileFromResponse(_);if(I!=="")if(y.info("Updating datafile from response"),this.currentDatafile=I,this.cache.set(this.cacheKey,I),!this.isReadyPromiseSettled)this.resolveReadyPromise();else{var F={datafile:I};this.emitter.emit(v,F)}}},p.prototype.onRequestComplete=function(){!this.isStarted||(this.currentRequest=null,!this.isReadyPromiseSettled&&!this.autoUpdate&&this.rejectReadyPromise(new Error("Failed to become ready")),this.autoUpdate&&this.syncOnCurrentRequestComplete&&this.syncDatafile(),this.syncOnCurrentRequestComplete=!1)},p.prototype.syncDatafile=function(){var _=this,I={};this.lastResponseLastModified&&(I["if-modified-since"]=this.lastResponseLastModified),y.debug("Making datafile request to url %s with headers: %s",this.datafileUrl,function(){return JSON.stringify(I)}),this.currentRequest=this.makeGetRequest(this.datafileUrl,I);var F=c(function(){_.onRequestComplete()},"onRequestComplete"),b=c(function(D){_.onRequestResolved(D)},"onRequestResolved"),A=c(function(D){_.onRequestRejected(D)},"onRequestRejected");this.currentRequest.responsePromise.then(b,A).then(F,F),this.autoUpdate&&this.scheduleNextUpdate()},p.prototype.resolveReadyPromise=function(){this.readyPromiseResolver(),this.isReadyPromiseSettled=!0},p.prototype.rejectReadyPromise=function(_){this.readyPromiseRejecter(_),this.isReadyPromiseSettled=!0},p.prototype.scheduleNextUpdate=function(){var _=this,I=this.backoffController.getDelay(),F=Math.max(I,this.updateInterval);y.debug("Scheduling sync in %s ms",F),this.currentTimeout=setTimeout(function(){_.currentRequest?_.syncOnCurrentRequestComplete=!0:_.syncDatafile()},F)},p.prototype.getNextDatafileFromResponse=function(_){return y.debug("Response status code: %s",_.statusCode),typeof _.statusCode>"u"||_.statusCode===304?"":a(_.statusCode)?_.body:""},p.prototype.trySavingLastModified=function(_){var I=_["last-modified"]||_["Last-Modified"];typeof I<"u"&&(this.lastResponseLastModified=I,y.debug("Saved last modified header value from response: %s",this.lastResponseLastModified))},p.prototype.setDatafileFromCacheIfAvailable=function(){var _=this;this.cache.get(this.cacheKey).then(function(I){_.isStarted&&!_.isReadyPromiseSettled&&I!==""&&(y.debug("Using datafile from cache"),_.currentDatafile=I,_.resolveReadyPromise())})},p}();g.default=u},62002:(X,g,U)=>{"use strict";var O;O={value:!0};var P=U(20731);g.z=P.default},67473:(X,g)=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0})},24909:(X,g,U)=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0}),g.sendEventNotification=g.getQueue=g.validateAndGetBatchSize=g.validateAndGetFlushInterval=g.DEFAULT_BATCH_SIZE=g.DEFAULT_FLUSH_INTERVAL=void 0;var O=U(31459),P=U(98125),C=U(27378);g.DEFAULT_FLUSH_INTERVAL=3e4,g.DEFAULT_BATCH_SIZE=10;var T=P.getLogger("EventProcessor");function h(v){return v<=0&&(T.warn("Invalid flushInterval "+v+", defaulting to "+g.DEFAULT_FLUSH_INTERVAL),v=g.DEFAULT_FLUSH_INTERVAL),v}c(h,"validateAndGetFlushInterval"),g.validateAndGetFlushInterval=h;function N(v){return v=Math.floor(v),v<1&&(T.warn("Invalid batchSize "+v+", defaulting to "+g.DEFAULT_BATCH_SIZE),v=g.DEFAULT_BATCH_SIZE),v=Math.max(1,v),v}c(N,"validateAndGetBatchSize"),g.validateAndGetBatchSize=N;function L(v,M,a,E){var u;return v>1?u=new O.DefaultEventQueue({flushInterval:M,maxQueueSize:v,sink:a,batchComparator:E}):u=new O.SingleEventQueue({sink:a}),u}c(L,"getQueue"),g.getQueue=L;function y(v,M){v&&v.sendNotifications(C.NOTIFICATION_TYPES.LOG_EVENT,M)}c(y,"sendEventNotification"),g.sendEventNotification=y},31459:(X,g,U)=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0}),g.DefaultEventQueue=g.SingleEventQueue=void 0;var O=U(98125),P=O.getLogger("EventProcessor"),C=function(){function N(L){var y=L.timeout,v=L.callback;this.timeout=Math.max(y,0),this.callback=v}return c(N,"Timer"),N.prototype.start=function(){this.timeoutId=setTimeout(this.callback,this.timeout)},N.prototype.refresh=function(){this.stop(),this.start()},N.prototype.stop=function(){this.timeoutId&&clearTimeout(this.timeoutId)},N}(),T=function(){function N(L){var y=L.sink;this.sink=y}return c(N,"SingleEventQueue"),N.prototype.start=function(){},N.prototype.stop=function(){return Promise.resolve()},N.prototype.enqueue=function(L){this.sink([L])},N}();g.SingleEventQueue=T;var h=function(){function N(L){var y=L.flushInterval,v=L.maxQueueSize,M=L.sink,a=L.batchComparator;this.buffer=[],this.maxQueueSize=Math.max(v,1),this.sink=M,this.batchComparator=a,this.timer=new C({callback:this.flush.bind(this),timeout:y}),this.started=!1}return c(N,"DefaultEventQueue"),N.prototype.start=function(){this.started=!0},N.prototype.stop=function(){this.started=!1;var L=this.sink(this.buffer);return this.buffer=[],this.timer.stop(),L},N.prototype.enqueue=function(L){if(!this.started){P.warn("Queue is stopped, not accepting event");return}var y=this.buffer[0];y&&!this.batchComparator(y,L)&&this.flush(),this.buffer.length===0&&this.timer.refresh(),this.buffer.push(L),this.buffer.length>=this.maxQueueSize&&this.flush()},N.prototype.flush=function(){this.sink(this.buffer),this.buffer=[],this.timer.stop()},N}();g.DefaultEventQueue=h},51074:(X,g)=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0}),g.areEventContextsEqual=void 0;function U(O,P){var C=O.context,T=P.context;return C.accountId===T.accountId&&C.projectId===T.projectId&&C.clientName===T.clientName&&C.clientVersion===T.clientVersion&&C.revision===T.revision&&C.anonymizeIP===T.anonymizeIP&&C.botFiltering===T.botFiltering}c(U,"areEventContextsEqual"),g.areEventContextsEqual=U},65001:function(X,g,U){"use strict";var O=this&&this.__createBinding||(Object.create?function(C,T,h,N){N===void 0&&(N=h),Object.defineProperty(C,N,{enumerable:!0,get:function(){return T[h]}})}:function(C,T,h,N){N===void 0&&(N=h),C[N]=T[h]}),P=this&&this.__exportStar||function(C,T){for(var h in C)h!=="default"&&!Object.prototype.hasOwnProperty.call(T,h)&&O(T,C,h)};Object.defineProperty(g,"__esModule",{value:!0}),P(U(51074),g),P(U(24909),g),P(U(67473),g),P(U(21310),g),P(U(36896),g),P(U(97168),g),P(U(18994),g)},21310:(X,g)=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0})},36896:function(X,g,U){"use strict";var O=this&&this.__extends||function(){var y=c(function(v,M){return y=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,E){a.__proto__=E}||function(a,E){for(var u in E)Object.prototype.hasOwnProperty.call(E,u)&&(a[u]=E[u])},y(v,M)},"extendStatics");return function(v,M){y(v,M);function a(){this.constructor=v}c(a,"__"),v.prototype=M===null?Object.create(M):(a.prototype=M.prototype,new a)}}();Object.defineProperty(g,"__esModule",{value:!0}),g.LocalStoragePendingEventsDispatcher=g.PendingEventsDispatcher=void 0;var P=U(98125),C=U(36587),T=U(27378),h=P.getLogger("EventProcessor"),N=function(){function y(v){var M=v.eventDispatcher,a=v.store;this.dispatcher=M,this.store=a}return c(y,"PendingEventsDispatcher"),y.prototype.dispatchEvent=function(v,M){this.send({uuid:T.generateUUID(),timestamp:T.getTimestamp(),request:v},M)},y.prototype.sendPendingEvents=function(){var v=this,M=this.store.values();h.debug("Sending %s pending events from previous page",M.length),M.forEach(function(a){try{v.send(a,function(){})}catch{}})},y.prototype.send=function(v,M){var a=this;this.store.set(v.uuid,v),this.dispatcher.dispatchEvent(v.request,function(E){a.store.remove(v.uuid),M(E)})},y}();g.PendingEventsDispatcher=N;var L=function(y){O(v,y);function v(M){var a=M.eventDispatcher;return y.call(this,{eventDispatcher:a,store:new C.LocalStorageStore({maxValues:100,key:"fs_optly_pending_events"})})||this}return c(v,"LocalStoragePendingEventsDispatcher"),v}(N);g.LocalStoragePendingEventsDispatcher=L},36587:(X,g,U)=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0}),g.LocalStorageStore=void 0;var O=U(27378),P=U(98125),C=P.getLogger("EventProcessor"),T=function(){function h(N){var L=N.key,y=N.maxValues,v=y===void 0?1e3:y;this.LS_KEY=L,this.maxValues=v}return c(h,"LocalStorageStore"),h.prototype.get=function(N){return this.getMap()[N]||null},h.prototype.set=function(N,L){var y=this.getMap();y[N]=L,this.replace(y)},h.prototype.remove=function(N){var L=this.getMap();delete L[N],this.replace(L)},h.prototype.values=function(){return O.objectValues(this.getMap())},h.prototype.clear=function(){this.replace({})},h.prototype.replace=function(N){try{window.localStorage&&localStorage.setItem(this.LS_KEY,JSON.stringify(N)),this.clean()}catch(L){C.error(L)}},h.prototype.clean=function(){var N=this.getMap(),L=Object.keys(N),y=L.length-this.maxValues;if(!(y<1)){var v=L.map(function(a){return{key:a,value:N[a]}});v.sort(function(a,E){return a.value.timestamp-E.value.timestamp});for(var M=0;M<y;M++)delete N[v[M].key];this.replace(N)}},h.prototype.getMap=function(){try{var N=window.localStorage&&localStorage.getItem(this.LS_KEY);if(N)return JSON.parse(N)||{}}catch(L){C.error(L)}return{}},h}();g.LocalStorageStore=T},90522:(X,g)=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});var U=function(){function O(){this.reqsInFlightCount=0,this.reqsCompleteResolvers=[]}return c(O,"RequestTracker"),O.prototype.trackRequest=function(P){var C=this;this.reqsInFlightCount++;var T=c(function(){C.reqsInFlightCount--,C.reqsInFlightCount===0&&(C.reqsCompleteResolvers.forEach(function(h){return h()}),C.reqsCompleteResolvers=[])},"onReqComplete");P.then(T,T)},O.prototype.onRequestsComplete=function(){var P=this;return new Promise(function(C){P.reqsInFlightCount===0?C():P.reqsCompleteResolvers.push(C)})},O}();g.default=U},97168:function(X,g){"use strict";var U=this&&this.__assign||function(){return U=Object.assign||function(a){for(var E,u=1,p=arguments.length;u<p;u++){E=arguments[u];for(var _ in E)Object.prototype.hasOwnProperty.call(E,_)&&(a[_]=E[_])}return a},U.apply(this,arguments)};Object.defineProperty(g,"__esModule",{value:!0}),g.formatEvents=g.buildConversionEventV1=g.buildImpressionEventV1=g.makeBatchedEventV1=void 0;var O="campaign_activated",P="custom",C="$opt_bot_filtering";function T(a){var E=[],u=a[0];return a.forEach(function(p){if(p.type==="conversion"||p.type==="impression"){var _=L(p);p.type==="impression"?_.snapshots.push(N(p)):p.type==="conversion"&&_.snapshots.push(h(p)),E.push(_)}}),{client_name:u.context.clientName,client_version:u.context.clientVersion,account_id:u.context.accountId,project_id:u.context.projectId,revision:u.context.revision,anonymize_ip:u.context.anonymizeIP,enrich_decisions:!0,visitors:E}}c(T,"makeBatchedEventV1"),g.makeBatchedEventV1=T;function h(a){var E=U({},a.tags);delete E.revenue,delete E.value;var u={entity_id:a.event.id,key:a.event.key,timestamp:a.timestamp,uuid:a.uuid};return a.tags&&(u.tags=a.tags),a.value!=null&&(u.value=a.value),a.revenue!=null&&(u.revenue=a.revenue),{events:[u]}}c(h,"makeConversionSnapshot");function N(a){var E,u,p=a.layer,_=a.experiment,I=a.variation,F=a.ruleKey,b=a.flagKey,A=a.ruleType,D=a.enabled,k=p?p.id:null,Z=(E=_?.id)!==null&&E!==void 0?E:"",re=(u=I?.id)!==null&&u!==void 0?u:"",Ee=I?I.key:"";return{decisions:[{campaign_id:k,experiment_id:Z,variation_id:re,metadata:{flag_key:b,rule_key:F,rule_type:A,variation_key:Ee,enabled:D}}],events:[{entity_id:k,timestamp:a.timestamp,key:O,uuid:a.uuid}]}}c(N,"makeDecisionSnapshot");function L(a){var E={snapshots:[],visitor_id:a.user.id,attributes:[]};return a.user.attributes.forEach(function(u){E.attributes.push({entity_id:u.entityId,key:u.key,type:"custom",value:u.value})}),typeof a.context.botFiltering=="boolean"&&E.attributes.push({entity_id:C,key:C,type:P,value:a.context.botFiltering}),E}c(L,"makeVisitor");function y(a){var E=L(a);return E.snapshots.push(N(a)),{client_name:a.context.clientName,client_version:a.context.clientVersion,account_id:a.context.accountId,project_id:a.context.projectId,revision:a.context.revision,anonymize_ip:a.context.anonymizeIP,enrich_decisions:!0,visitors:[E]}}c(y,"buildImpressionEventV1"),g.buildImpressionEventV1=y;function v(a){var E=L(a);return E.snapshots.push(h(a)),{client_name:a.context.clientName,client_version:a.context.clientVersion,account_id:a.context.accountId,project_id:a.context.projectId,revision:a.context.revision,anonymize_ip:a.context.anonymizeIP,enrich_decisions:!0,visitors:[E]}}c(v,"buildConversionEventV1"),g.buildConversionEventV1=v;function M(a){return{url:"https://logx.optimizely.com/v1/events",httpVerb:"POST",params:T(a)}}c(M,"formatEvents"),g.formatEvents=M},18994:function(X,g,U){"use strict";var O=this&&this.__awaiter||function(a,E,u,p){function _(I){return I instanceof u?I:new u(function(F){F(I)})}return c(_,"adopt"),new(u||(u=Promise))(function(I,F){function b(k){try{D(p.next(k))}catch(Z){F(Z)}}c(b,"fulfilled");function A(k){try{D(p.throw(k))}catch(Z){F(Z)}}c(A,"rejected");function D(k){k.done?I(k.value):_(k.value).then(b,A)}c(D,"step"),D((p=p.apply(a,E||[])).next())})},P=this&&this.__generator||function(a,E){var u={label:0,sent:function(){if(I[0]&1)throw I[1];return I[1]},trys:[],ops:[]},p,_,I,F;return F={next:b(0),throw:b(1),return:b(2)},typeof Symbol=="function"&&(F[Symbol.iterator]=function(){return this}),F;function b(D){return function(k){return A([D,k])}}function A(D){if(p)throw new TypeError("Generator is already executing.");for(;u;)try{if(p=1,_&&(I=D[0]&2?_.return:D[0]?_.throw||((I=_.return)&&I.call(_),0):_.next)&&!(I=I.call(_,D[1])).done)return I;switch(_=0,I&&(D=[D[0]&2,I.value]),D[0]){case 0:case 1:I=D;break;case 4:return u.label++,{value:D[1],done:!1};case 5:u.label++,_=D[1],D=[0];continue;case 7:D=u.ops.pop(),u.trys.pop();continue;default:if(I=u.trys,!(I=I.length>0&&I[I.length-1])&&(D[0]===6||D[0]===2)){u=0;continue}if(D[0]===3&&(!I||D[1]>I[0]&&D[1]<I[3])){u.label=D[1];break}if(D[0]===6&&u.label<I[1]){u.label=I[1],I=D;break}if(I&&u.label<I[2]){u.label=I[2],u.ops.push(D);break}I[2]&&u.ops.pop(),u.trys.pop();continue}D=E.call(a,u)}catch(k){D=[6,k],_=0}finally{p=I=0}if(D[0]&5)throw D[1];return{value:D[0]?D[1]:void 0,done:!0}}},C=this&&this.__importDefault||function(a){return a&&a.__esModule?a:{default:a}};Object.defineProperty(g,"__esModule",{value:!0}),g.LogTierV1EventProcessor=void 0;var T=U(98125),h=U(24909),N=C(U(90522)),L=U(51074),y=U(97168),v=T.getLogger("LogTierV1EventProcessor"),M=function(){function a(E){var u=E.dispatcher,p=E.flushInterval,_=p===void 0?h.DEFAULT_FLUSH_INTERVAL:p,I=E.batchSize,F=I===void 0?h.DEFAULT_BATCH_SIZE:I,b=E.notificationCenter;this.dispatcher=u,this.notificationCenter=b,this.requestTracker=new N.default,_=h.validateAndGetFlushInterval(_),F=h.validateAndGetBatchSize(F),this.queue=h.getQueue(F,_,this.drainQueue.bind(this),L.areEventContextsEqual)}return c(a,"LogTierV1EventProcessor"),a.prototype.drainQueue=function(E){var u=this,p=new Promise(function(_){if(v.debug("draining queue with %s events",E.length),E.length===0){_();return}var I=y.formatEvents(E);u.dispatcher.dispatchEvent(I,function(){_()}),h.sendEventNotification(u.notificationCenter,I)});return this.requestTracker.trackRequest(p),p},a.prototype.process=function(E){this.queue.enqueue(E)},a.prototype.stop=function(){try{return this.queue.stop(),this.requestTracker.onRequestsComplete()}catch(E){v.error('Error stopping EventProcessor: "%s"',E.message,E)}return Promise.resolve()},a.prototype.start=function(){return O(this,void 0,void 0,function(){return P(this,function(E){return this.queue.start(),[2]})})},a}();g.LogTierV1EventProcessor=M},27987:(X,g)=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});var U=function(){function h(){}return c(h,"NoopErrorHandler"),h.prototype.handleError=function(N){},h}();g.NoopErrorHandler=U;var O=new U;function P(h){O=h}c(P,"setErrorHandler"),g.setErrorHandler=P;function C(){return O}c(C,"getErrorHandler"),g.getErrorHandler=C;function T(){O=new U}c(T,"resetErrorHandler"),g.resetErrorHandler=T},98125:(X,g,U)=>{"use strict";function O(P){for(var C in P)g.hasOwnProperty(C)||(g[C]=P[C])}c(O,"__export"),Object.defineProperty(g,"__esModule",{value:!0}),O(U(27987)),O(U(99623)),O(U(46773))},46773:function(X,g,U){"use strict";var O=this&&this.__spreadArrays||function(){for(var b=0,A=0,D=arguments.length;A<D;A++)b+=arguments[A].length;for(var k=Array(b),Z=0,A=0;A<D;A++)for(var re=arguments[A],Ee=0,ge=re.length;Ee<ge;Ee++,Z++)k[Z]=re[Ee];return k};Object.defineProperty(g,"__esModule",{value:!0});var P=U(27987),C=U(27378),T=U(99623),h={NOTSET:0,DEBUG:1,INFO:2,WARNING:3,ERROR:4};function N(b){return typeof b!="string"||(b=b.toUpperCase(),b==="WARN"&&(b="WARNING"),!h[b])?b:h[b]}c(N,"coerceLogLevel");var L=function(){function b(){this.defaultLoggerFacade=new a,this.loggers={}}return c(b,"DefaultLogManager"),b.prototype.getLogger=function(A){return A?(this.loggers[A]||(this.loggers[A]=new a({messagePrefix:A})),this.loggers[A]):this.defaultLoggerFacade},b}(),y=function(){function b(A){A===void 0&&(A={}),this.logLevel=T.LogLevel.NOTSET,A.logLevel!==void 0&&C.isValidEnum(T.LogLevel,A.logLevel)&&this.setLogLevel(A.logLevel),this.logToConsole=A.logToConsole!==void 0?!!A.logToConsole:!0,this.prefix=A.prefix!==void 0?A.prefix:"[OPTIMIZELY]"}return c(b,"ConsoleLogHandler"),b.prototype.log=function(A,D){if(!(!this.shouldLog(A)||!this.logToConsole)){var k=this.prefix+" - "+this.getLogLevelName(A)+" "+this.getTime()+" "+D;this.consoleLog(A,[k])}},b.prototype.setLogLevel=function(A){A=N(A),!C.isValidEnum(T.LogLevel,A)||A===void 0?this.logLevel=T.LogLevel.ERROR:this.logLevel=A},b.prototype.getTime=function(){return new Date().toISOString()},b.prototype.shouldLog=function(A){return A>=this.logLevel},b.prototype.getLogLevelName=function(A){switch(A){case T.LogLevel.DEBUG:return"DEBUG";case T.LogLevel.INFO:return"INFO ";case T.LogLevel.WARNING:return"WARN ";case T.LogLevel.ERROR:return"ERROR";default:return"NOTSET"}},b.prototype.consoleLog=function(A,D){switch(A){case T.LogLevel.DEBUG:console.log.apply(console,D);break;case T.LogLevel.INFO:console.info.apply(console,D);break;case T.LogLevel.WARNING:console.warn.apply(console,D);break;case T.LogLevel.ERROR:console.error.apply(console,D);break;default:console.log.apply(console,D)}},b}();g.ConsoleLogHandler=y;var v=T.LogLevel.NOTSET,M=null,a=function(){function b(A){A===void 0&&(A={}),this.messagePrefix="",A.messagePrefix&&(this.messagePrefix=A.messagePrefix)}return c(b,"OptimizelyLogger"),b.prototype.log=function(A,D){for(var k=[],Z=2;Z<arguments.length;Z++)k[Z-2]=arguments[Z];this.internalLog(N(A),{message:D,splat:k})},b.prototype.info=function(A){for(var D=[],k=1;k<arguments.length;k++)D[k-1]=arguments[k];this.namedLog(T.LogLevel.INFO,A,D)},b.prototype.debug=function(A){for(var D=[],k=1;k<arguments.length;k++)D[k-1]=arguments[k];this.namedLog(T.LogLevel.DEBUG,A,D)},b.prototype.warn=function(A){for(var D=[],k=1;k<arguments.length;k++)D[k-1]=arguments[k];this.namedLog(T.LogLevel.WARNING,A,D)},b.prototype.error=function(A){for(var D=[],k=1;k<arguments.length;k++)D[k-1]=arguments[k];this.namedLog(T.LogLevel.ERROR,A,D)},b.prototype.format=function(A){return(this.messagePrefix?this.messagePrefix+": ":"")+C.sprintf.apply(void 0,O([A.message],A.splat))},b.prototype.internalLog=function(A,D){!M||A<v||(M.log(A,this.format(D)),D.error&&D.error instanceof Error&&P.getErrorHandler().handleError(D.error))},b.prototype.namedLog=function(A,D,k){var Z;if(D instanceof Error){Z=D,D=Z.message,this.internalLog(A,{error:Z,message:D,splat:k});return}if(k.length===0){this.internalLog(A,{message:D,splat:k});return}var re=k[k.length-1];re instanceof Error&&(Z=re,k.splice(-1)),this.internalLog(A,{message:D,error:Z,splat:k})},b}(),E=new L;function u(b){return E.getLogger(b)}c(u,"getLogger"),g.getLogger=u;function p(b){M=b}c(p,"setLogHandler"),g.setLogHandler=p;function _(b){b=N(b),!C.isValidEnum(T.LogLevel,b)||b===void 0?v=T.LogLevel.ERROR:v=b}c(_,"setLogLevel"),g.setLogLevel=_;function I(){return v}c(I,"getLogLevel"),g.getLogLevel=I;function F(){E=new L,v=T.LogLevel.NOTSET}c(F,"resetLogger"),g.resetLogger=F},99623:(X,g)=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});var U;(function(O){O[O.NOTSET=0]="NOTSET",O[O.DEBUG=1]="DEBUG",O[O.INFO=2]="INFO",O[O.WARNING=3]="WARNING",O[O.ERROR=4]="ERROR"})(U=g.LogLevel||(g.LogLevel={}))},27378:(X,g,U)=>{"use strict";Object.defineProperty(g,"__esModule",{value:!0});var O=U(969);function P(){return O.v4()}c(P,"generateUUID"),g.generateUUID=P;function C(){return new Date().getTime()}c(C,"getTimestamp"),g.getTimestamp=C;function T(E,u){for(var p=!1,_=Object.keys(E),I=0;I<_.length;I++)if(u===E[_[I]]){p=!0;break}return p}c(T,"isValidEnum"),g.isValidEnum=T;function h(E,u){var p={};return E.forEach(function(_){var I=u(_);p[I]=p[I]||[],p[I].push(_)}),N(p)}c(h,"groupBy"),g.groupBy=h;function N(E){return Object.keys(E).map(function(u){return E[u]})}c(N,"objectValues"),g.objectValues=N;function L(E){return Object.keys(E).map(function(u){return[u,E[u]]})}c(L,"objectEntries"),g.objectEntries=L;function y(E,u){for(var p,_=0,I=E;_<I.length;_++){var F=I[_];if(u(F)){p=F;break}}return p}c(y,"find"),g.find=y;function v(E,u){var p={};return E.forEach(function(_){var I=u(_);p[I]=_}),p}c(v,"keyBy"),g.keyBy=v;function M(E){for(var u=[],p=1;p<arguments.length;p++)u[p-1]=arguments[p];var _=0;return E.replace(/%s/g,function(){var I=u[_++],F=typeof I;return F==="function"?I():F==="string"?I:String(I)})}c(M,"sprintf"),g.sprintf=M;var a;(function(E){E.ACTIVATE="ACTIVATE:experiment, user_id,attributes, variation, event",E.DECISION="DECISION:type, userId, attributes, decisionInfo",E.LOG_EVENT="LOG_EVENT:logEvent",E.OPTIMIZELY_CONFIG_UPDATE="OPTIMIZELY_CONFIG_UPDATE",E.TRACK="TRACK:event_key, user_id, attributes, event_tags, event"})(a=g.NOTIFICATION_TYPES||(g.NOTIFICATION_TYPES={}))},48266:(X,g,U)=>{"use strict";U.d(g,{ZP:()=>Vt});var O=U(98125),P=U.n(O),C=U(65001),T=U.n(C),h=U(27378),N=U(58053),L=U.n(N),y=U(62002);/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var v=c(function(){return(v=Object.assign||function(r){for(var e,t=1,n=arguments.length;t<n;t++)for(var i in e=arguments[t])Object.prototype.hasOwnProperty.call(e,i)&&(r[i]=e[i]);return r}).apply(this,arguments)},"N");function M(){for(var r=0,e=0,t=arguments.length;e<t;e++)r+=arguments[e].length;var n=Array(r),i=0;for(e=0;e<t;e++)for(var o=arguments[e],s=0,f=o.length;s<f;s++,i++)n[i]=o[s];return n}c(M,"R");var a={NOTSET:0,DEBUG:1,INFO:2,WARNING:3,ERROR:4},E={CONDITION_EVALUATOR_ERROR:"%s: Error evaluating audience condition of type %s: %s",DATAFILE_AND_SDK_KEY_MISSING:"%s: You must provide at least one of sdkKey or datafile. Cannot start Optimizely",EXPERIMENT_KEY_NOT_IN_DATAFILE:"%s: Experiment key %s is not in datafile.",FEATURE_NOT_IN_DATAFILE:"%s: Feature key %s is not in datafile.",IMPROPERLY_FORMATTED_EXPERIMENT:"%s: Experiment key %s is improperly formatted.",INVALID_ATTRIBUTES:"%s: Provided attributes are in an invalid format.",INVALID_BUCKETING_ID:"%s: Unable to generate hash for bucketing ID %s: %s",INVALID_DATAFILE:"%s: Datafile is invalid - property %s: %s",INVALID_DATAFILE_MALFORMED:"%s: Datafile is invalid because it is malformed.",INVALID_CONFIG:"%s: Provided Optimizely config is in an invalid format.",INVALID_JSON:"%s: JSON object is not valid.",INVALID_ERROR_HANDLER:'%s: Provided "errorHandler" is in an invalid format.',INVALID_EVENT_DISPATCHER:'%s: Provided "eventDispatcher" is in an invalid format.',INVALID_EVENT_TAGS:"%s: Provided event tags are in an invalid format.",INVALID_EXPERIMENT_KEY:"%s: Experiment key %s is not in datafile. It is either invalid, paused, or archived.",INVALID_EXPERIMENT_ID:"%s: Experiment ID %s is not in datafile.",INVALID_GROUP_ID:"%s: Group ID %s is not in datafile.",INVALID_LOGGER:'%s: Provided "logger" is in an invalid format.',INVALID_ROLLOUT_ID:"%s: Invalid rollout ID %s attached to feature %s",INVALID_USER_ID:"%s: Provided user ID is in an invalid format.",INVALID_USER_PROFILE_SERVICE:"%s: Provided user profile service instance is in an invalid format: %s.",NO_DATAFILE_SPECIFIED:"%s: No datafile specified. Cannot start optimizely.",NO_JSON_PROVIDED:"%s: No JSON object to validate against schema.",NO_VARIATION_FOR_EXPERIMENT_KEY:"%s: No variation key %s defined in datafile for experiment %s.",UNDEFINED_ATTRIBUTE:"%s: Provided attribute: %s has an undefined value.",UNRECOGNIZED_ATTRIBUTE:"%s: Unrecognized attribute %s provided. Pruning before sending event to Optimizely.",UNABLE_TO_CAST_VALUE:"%s: Unable to cast value %s to type %s, returning null.",USER_NOT_IN_FORCED_VARIATION:"%s: User %s is not in the forced variation map. Cannot remove their forced variation.",USER_PROFILE_LOOKUP_ERROR:'%s: Error while looking up user profile for user ID "%s": %s.',USER_PROFILE_SAVE_ERROR:'%s: Error while saving user profile for user ID "%s": %s.',VARIABLE_KEY_NOT_IN_DATAFILE:'%s: Variable with key "%s" associated with feature with key "%s" is not in datafile.',VARIATION_ID_NOT_IN_DATAFILE:"%s: No variation ID %s defined in datafile for experiment %s.",VARIATION_ID_NOT_IN_DATAFILE_NO_EXPERIMENT:"%s: Variation ID %s is not in the datafile.",INVALID_INPUT_FORMAT:"%s: Provided %s is in an invalid format.",INVALID_DATAFILE_VERSION:"%s: This version of the JavaScript SDK does not support the given datafile version: %s",INVALID_VARIATION_KEY:"%s: Provided variation key is in an invalid format."},u={ACTIVATE_USER:"%s: Activating user %s in experiment %s.",DISPATCH_CONVERSION_EVENT:"%s: Dispatching conversion event to URL %s with params %s.",DISPATCH_IMPRESSION_EVENT:"%s: Dispatching impression event to URL %s with params %s.",DEPRECATED_EVENT_VALUE:"%s: Event value is deprecated in %s call.",EVENT_KEY_NOT_FOUND:"%s: Event key %s is not in datafile.",EXPERIMENT_NOT_RUNNING:"%s: Experiment %s is not running.",FEATURE_ENABLED_FOR_USER:"%s: Feature %s is enabled for user %s.",FEATURE_NOT_ENABLED_FOR_USER:"%s: Feature %s is not enabled for user %s.",FEATURE_HAS_NO_EXPERIMENTS:"%s: Feature %s is not attached to any experiments.",FAILED_TO_PARSE_VALUE:'%s: Failed to parse event value "%s" from event tags.',FAILED_TO_PARSE_REVENUE:'%s: Failed to parse revenue value "%s" from event tags.',FORCED_BUCKETING_FAILED:"%s: Variation key %s is not in datafile. Not activating user %s.",INVALID_OBJECT:"%s: Optimizely object is not valid. Failing %s.",INVALID_CLIENT_ENGINE:"%s: Invalid client engine passed: %s. Defaulting to node-sdk.",INVALID_DEFAULT_DECIDE_OPTIONS:"%s: Provided default decide options is not an array.",INVALID_DECIDE_OPTIONS:"%s: Provided decide options is not an array. Using default decide options.",INVALID_VARIATION_ID:"%s: Bucketed into an invalid variation ID. Returning null.",NOTIFICATION_LISTENER_EXCEPTION:"%s: Notification listener for (%s) threw exception: %s",NO_ROLLOUT_EXISTS:"%s: There is no rollout of feature %s.",NOT_ACTIVATING_USER:"%s: Not activating user %s for experiment %s.",NOT_TRACKING_USER:"%s: Not tracking user %s.",PARSED_REVENUE_VALUE:'%s: Parsed revenue value "%s" from event tags.',PARSED_NUMERIC_VALUE:'%s: Parsed event value "%s" from event tags.',RETURNING_STORED_VARIATION:'%s: Returning previously activated variation "%s" of experiment "%s" for user "%s" from user profile.',ROLLOUT_HAS_NO_EXPERIMENTS:"%s: Rollout of feature %s has no experiments",SAVED_VARIATION:'%s: Saved variation "%s" of experiment "%s" for user "%s".',SAVED_VARIATION_NOT_FOUND:"%s: User %s was previously bucketed into variation with ID %s for experiment %s, but no matching variation was found.",SHOULD_NOT_DISPATCH_ACTIVATE:'%s: Experiment %s is not in "Running" state. Not activating user.',SKIPPING_JSON_VALIDATION:"%s: Skipping JSON schema validation.",TRACK_EVENT:"%s: Tracking event %s for user %s.",UNRECOGNIZED_DECIDE_OPTION:"%s: Unrecognized decide option %s provided.",USER_ASSIGNED_TO_EXPERIMENT_BUCKET:"%s: Assigned bucket %s to user with bucketing ID %s.",USER_BUCKETED_INTO_EXPERIMENT_IN_GROUP:"%s: User %s is in experiment %s of group %s.",USER_BUCKETED_INTO_TARGETING_RULE:"%s: User %s bucketed into targeting rule %s.",USER_IN_FEATURE_EXPERIMENT:"%s: User %s is in variation %s of experiment %s on the feature %s.",USER_IN_ROLLOUT:"%s: User %s is in rollout of feature %s.",USER_NOT_BUCKETED_INTO_EVERYONE_TARGETING_RULE:"%s: User %s not bucketed into everyone targeting rule due to traffic allocation.",USER_NOT_BUCKETED_INTO_EXPERIMENT_IN_GROUP:"%s: User %s is not in experiment %s of group %s.",USER_NOT_BUCKETED_INTO_ANY_EXPERIMENT_IN_GROUP:"%s: User %s is not in any experiment of group %s.",USER_NOT_BUCKETED_INTO_TARGETING_RULE:"%s User %s not bucketed into targeting rule %s due to traffic allocation. Trying everyone rule.",USER_NOT_IN_FEATURE_EXPERIMENT:"%s: User %s is not in any experiment on the feature %s.",USER_NOT_IN_ROLLOUT:"%s: User %s is not in rollout of feature %s.",USER_FORCED_IN_VARIATION:"%s: User %s is forced in variation %s.",USER_MAPPED_TO_FORCED_VARIATION:"%s: Set variation %s for experiment %s and user %s in the forced variation map.",USER_DOESNT_MEET_CONDITIONS_FOR_TARGETING_RULE:"%s: User %s does not meet conditions for targeting rule %s.",USER_MEETS_CONDITIONS_FOR_TARGETING_RULE:"%s: User %s meets conditions for targeting rule %s.",USER_HAS_VARIATION:"%s: User %s is in variation %s of experiment %s.",USER_HAS_FORCED_DECISION_WITH_RULE_SPECIFIED:"Variation (%s) is mapped to flag (%s), rule (%s) and user (%s) in the forced decision map.",USER_HAS_FORCED_DECISION_WITH_NO_RULE_SPECIFIED:"Variation (%s) is mapped to flag (%s) and user (%s) in the forced decision map.",USER_HAS_FORCED_DECISION_WITH_RULE_SPECIFIED_BUT_INVALID:"Invalid variation is mapped to flag (%s), rule (%s) and user (%s) in the forced decision map.",USER_HAS_FORCED_DECISION_WITH_NO_RULE_SPECIFIED_BUT_INVALID:"Invalid variation is mapped to flag (%s) and user (%s) in the forced decision map.",USER_HAS_FORCED_VARIATION:"%s: Variation %s is mapped to experiment %s and user %s in the forced variation map.",USER_HAS_NO_VARIATION:"%s: User %s is in no variation of experiment %s.",USER_HAS_NO_FORCED_VARIATION:"%s: User %s is not in the forced variation map.",USER_HAS_NO_FORCED_VARIATION_FOR_EXPERIMENT:"%s: No experiment %s mapped to user %s in the forced variation map.",USER_NOT_IN_ANY_EXPERIMENT:"%s: User %s is not in any experiment of group %s.",USER_NOT_IN_EXPERIMENT:"%s: User %s does not meet conditions to be in experiment %s.",USER_RECEIVED_DEFAULT_VARIABLE_VALUE:'%s: User "%s" is not in any variation or rollout rule. Returning default value for variable "%s" of feature flag "%s".',FEATURE_NOT_ENABLED_RETURN_DEFAULT_VARIABLE_VALUE:'%s: Feature "%s" is not enabled for user %s. Returning the default variable value "%s".',VARIABLE_NOT_USED_RETURN_DEFAULT_VARIABLE_VALUE:'%s: Variable "%s" is not used in variation "%s". Returning default value.',USER_RECEIVED_VARIABLE_VALUE:'%s: Got variable value "%s" for variable "%s" of feature flag "%s"',VALID_DATAFILE:"%s: Datafile is valid.",VALID_USER_PROFILE_SERVICE:"%s: Valid user profile service provided.",VARIATION_REMOVED_FOR_USER:"%s: Variation mapped to experiment %s has been removed for user %s.",VARIABLE_REQUESTED_WITH_WRONG_TYPE:'%s: Requested variable type "%s", but variable is of type "%s". Use correct API to retrieve value. Returning None.',VALID_BUCKETING_ID:'%s: BucketingId is valid: "%s"',BUCKETING_ID_NOT_STRING:"%s: BucketingID attribute is not a string. Defaulted to userId",EVALUATING_AUDIENCE:'%s: Starting to evaluate audience "%s" with conditions: %s.',EVALUATING_AUDIENCES_COMBINED:'%s: Evaluating audiences for %s "%s": %s.',AUDIENCE_EVALUATION_RESULT:'%s: Audience "%s" evaluated to %s.',AUDIENCE_EVALUATION_RESULT_COMBINED:"%s: Audiences for %s %s collectively evaluated to %s.",MISSING_ATTRIBUTE_VALUE:'%s: Audience condition %s evaluated to UNKNOWN because no value was passed for user attribute "%s".',UNEXPECTED_CONDITION_VALUE:"%s: Audience condition %s evaluated to UNKNOWN because the condition value is not supported.",UNEXPECTED_TYPE:'%s: Audience condition %s evaluated to UNKNOWN because a value of type "%s" was passed for user attribute "%s".',UNEXPECTED_TYPE_NULL:'%s: Audience condition %s evaluated to UNKNOWN because a null value was passed for user attribute "%s".',UNKNOWN_CONDITION_TYPE:"%s: Audience condition %s has an unknown condition type. You may need to upgrade to a newer release of the Optimizely SDK.",UNKNOWN_MATCH_TYPE:"%s: Audience condition %s uses an unknown match type. You may need to upgrade to a newer release of the Optimizely SDK.",UPDATED_OPTIMIZELY_CONFIG:"%s: Updated Optimizely config to revision %s (project id %s)",OUT_OF_BOUNDS:'%s: Audience condition %s evaluated to UNKNOWN because the number value for user attribute "%s" is not in the range [-2^53, +2^53].',UNABLE_TO_ATTACH_UNLOAD:'%s: unable to bind optimizely.close() to page unload event: "%s"'},p={BOT_FILTERING:"$opt_bot_filtering",BUCKETING_ID:"$opt_bucketing_id",STICKY_BUCKETING_KEY:"$opt_experiment_bucket_map",USER_AGENT:"$opt_user_agent",FORCED_DECISION_NULL_RULE_KEY:"$opt_null_rule_key"},_=h.NOTIFICATION_TYPES,I={AB_TEST:"ab-test",FEATURE:"feature",FEATURE_TEST:"feature-test",FEATURE_VARIABLE:"feature-variable",ALL_FEATURE_VARIABLES:"all-feature-variables",FLAG:"flag"},F={FEATURE_TEST:"feature-test",ROLLOUT:"rollout",EXPERIMENT:"experiment"},b={RULE:"rule",EXPERIMENT:"experiment"},A={BOOLEAN:"boolean",DOUBLE:"double",INTEGER:"integer",STRING:"string",JSON:"json"},D={V2:"2",V3:"3",V4:"4"},k={SDK_NOT_READY:"Optimizely SDK not configured properly yet.",FLAG_KEY_INVALID:'No flag was found for key "%s".',VARIABLE_VALUE_INVALID:'Variable value for key "%s" is invalid or wrong type.'},Z=Object.freeze({__proto__:null,LOG_LEVEL:a,ERROR_MESSAGES:E,LOG_MESSAGES:u,CONTROL_ATTRIBUTES:p,JAVASCRIPT_CLIENT_ENGINE:"javascript-sdk",NODE_CLIENT_ENGINE:"node-sdk",REACT_CLIENT_ENGINE:"react-sdk",REACT_NATIVE_CLIENT_ENGINE:"react-native-sdk",REACT_NATIVE_JS_CLIENT_ENGINE:"react-native-js-sdk",NODE_CLIENT_VERSION:"4.9.1",NOTIFICATION_TYPES:_,DECISION_NOTIFICATION_TYPES:I,DECISION_SOURCES:F,AUDIENCE_EVALUATION_TYPES:b,FEATURE_VARIABLE_TYPES:A,DATAFILE_VERSIONS:D,DECISION_MESSAGES:k}),re="CONFIG_VALIDATOR",Ee=[D.V2,D.V3,D.V4],ge=c(function(r){if(typeof r=="object"&&r!==null){var e=r,t=e.errorHandler,n=e.eventDispatcher,i=e.logger;if(t&&typeof t.handleError!="function")throw new Error((0,h.sprintf)(E.INVALID_ERROR_HANDLER,re));if(n&&typeof n.dispatchEvent!="function")throw new Error((0,h.sprintf)(E.INVALID_EVENT_DISPATCHER,re));if(i&&typeof i.log!="function")throw new Error((0,h.sprintf)(E.INVALID_LOGGER,re));return!0}throw new Error((0,h.sprintf)(E.INVALID_CONFIG,re))},"M"),he=c(function(r){if(!r)throw new Error((0,h.sprintf)(E.NO_DATAFILE_SPECIFIED,re));if(typeof r=="string")try{r=JSON.parse(r)}catch{throw new Error((0,h.sprintf)(E.INVALID_DATAFILE_MALFORMED,re))}if(typeof r=="object"&&!Array.isArray(r)&&r!==null&&Ee.indexOf(r.version)===-1)throw new Error((0,h.sprintf)(E.INVALID_DATAFILE_VERSION,re,r.version));return r},"P"),Ne={handleError:function(){}},Oe=c(function(r){return Object.keys(r).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(r[e])}).join("&")},"k"),S={dispatchEvent:function(r,e){var t,n=r.params,i=r.url;r.httpVerb==="POST"?((t=new XMLHttpRequest).open("POST",i,!0),t.setRequestHeader("Content-Type","application/json"),t.onreadystatechange=function(){if(t.readyState===4&&e&&typeof e=="function")try{e({statusCode:t.status})}catch{}},t.send(JSON.stringify(n))):(i+="?wxhr=true",n&&(i+="&"+Oe(n)),(t=new XMLHttpRequest).open("GET",i,!0),t.onreadystatechange=function(){if(t.readyState===4&&e&&typeof e=="function")try{e({statusCode:t.status})}catch{}},t.send())}},x=function(){function r(){}return c(r,"e"),r.prototype.log=function(){},r}();function B(r){return new O.ConsoleLogHandler(r)}c(B,"x");var Y,G,z=Object.freeze({__proto__:null,NoOpLogger:x,createLogger:B,createNoOpLogger:function(){return new x}});function H(r,e,t){return{variationKey:null,enabled:!1,variables:{},ruleKey:null,flagKey:r,userContext:e,reasons:t}}c(H,"Y"),function(r){r.BOOLEAN="boolean",r.DOUBLE="double",r.INTEGER="integer",r.STRING="string",r.JSON="json"}(Y||(Y={})),function(r){r.DISABLE_DECISION_EVENT="DISABLE_DECISION_EVENT",r.ENABLED_FLAGS_ONLY="ENABLED_FLAGS_ONLY",r.IGNORE_USER_PROFILE_SERVICE="IGNORE_USER_PROFILE_SERVICE",r.INCLUDE_REASONS="INCLUDE_REASONS",r.EXCLUDE_VARIABLES="EXCLUDE_VARIABLES"}(G||(G={}));var q=function(){function r(e){var t,n=e.optimizely,i=e.userId,o=e.attributes;this.optimizely=n,this.userId=i,this.attributes=(t=v({},o))!==null&&t!==void 0?t:{},this.forcedDecisionsMap={}}return c(r,"e"),r.prototype.setAttribute=function(e,t){this.attributes[e]=t},r.prototype.getUserId=function(){return this.userId},r.prototype.getAttributes=function(){return v({},this.attributes)},r.prototype.getOptimizely=function(){return this.optimizely},r.prototype.decide=function(e,t){return t===void 0&&(t=[]),this.optimizely.decide(this.cloneUserContext(),e,t)},r.prototype.decideForKeys=function(e,t){return t===void 0&&(t=[]),this.optimizely.decideForKeys(this.cloneUserContext(),e,t)},r.prototype.decideAll=function(e){return e===void 0&&(e=[]),this.optimizely.decideAll(this.cloneUserContext(),e)},r.prototype.trackEvent=function(e,t){this.optimizely.track(e,this.userId,this.attributes,t)},r.prototype.setForcedDecision=function(e,t){var n,i=e.flagKey,o=(n=e.ruleKey)!==null&&n!==void 0?n:p.FORCED_DECISION_NULL_RULE_KEY,s={variationKey:t.variationKey};return this.forcedDecisionsMap[i]||(this.forcedDecisionsMap[i]={}),this.forcedDecisionsMap[i][o]=s,!0},r.prototype.getForcedDecision=function(e){return this.findForcedDecision(e)},r.prototype.removeForcedDecision=function(e){var t,n=(t=e.ruleKey)!==null&&t!==void 0?t:p.FORCED_DECISION_NULL_RULE_KEY,i=e.flagKey,o=!1;return this.forcedDecisionsMap.hasOwnProperty(i)&&(this.forcedDecisionsMap[i].hasOwnProperty(n)&&(delete this.forcedDecisionsMap[i][n],o=!0),Object.keys(this.forcedDecisionsMap[i]).length===0&&delete this.forcedDecisionsMap[i]),o},r.prototype.removeAllForcedDecisions=function(){return this.forcedDecisionsMap={},!0},r.prototype.findForcedDecision=function(e){var t,n=(t=e.ruleKey)!==null&&t!==void 0?t:p.FORCED_DECISION_NULL_RULE_KEY,i=e.flagKey;if(this.forcedDecisionsMap.hasOwnProperty(e.flagKey)){var o=this.forcedDecisionsMap[i];if(o.hasOwnProperty(n))return{variationKey:o[n].variationKey}}return null},r.prototype.cloneUserContext=function(){var e=new r({optimizely:this.getOptimizely(),userId:this.getUserId(),attributes:this.getAttributes()});return Object.keys(this.forcedDecisionsMap).length>0&&(e.forcedDecisionsMap=v({},this.forcedDecisionsMap)),e},r}(),W=["and","or","not"];function J(r,e){if(Array.isArray(r)){var t=r[0],n=r.slice(1);switch(typeof t=="string"&&W.indexOf(t)===-1&&(t="or",n=r),t){case"and":return function(i,o){var s=!1;if(Array.isArray(i)){for(var f=0;f<i.length;f++){var l=J(i[f],o);if(l===!1)return!1;l===null&&(s=!0)}return!s||null}return null}(n,e);case"not":return function(i,o){if(Array.isArray(i)&&i.length>0){var s=J(i[0],o);return s===null?null:!s}return null}(n,e);default:return function(i,o){var s=!1;if(Array.isArray(i)){for(var f=0;f<i.length;f++){var l=J(i[f],o);if(l===!0)return!0;l===null&&(s=!0)}return!!s&&null}return null}(n,e)}}return e(r)}c(J,"J");var Q=function(){function r(e,t){var n,i;this.sdkKey=(n=e.sdkKey)!==null&&n!==void 0?n:"",this.environmentKey=(i=e.environmentKey)!==null&&i!==void 0?i:"",this.attributes=e.attributes,this.audiences=r.getAudiences(e),this.events=e.events,this.revision=e.revision;var o=(e.featureFlags||[]).reduce(function(f,l){return f[l.id]=l.variables,f},{}),s=r.getExperimentsMapById(e,o);this.experimentsMap=r.getExperimentsKeyMap(s),this.featuresMap=r.getFeaturesMap(e,o,s),this.datafile=t}return c(r,"e"),r.prototype.getDatafile=function(){return this.datafile},r.getAudiences=function(e){var t=[],n=[];return(e.typedAudiences||[]).forEach(function(i){t.push({id:i.id,conditions:JSON.stringify(i.conditions),name:i.name}),n.push(i.id)}),(e.audiences||[]).forEach(function(i){n.indexOf(i.id)===-1&&i.id!="$opt_dummy_audience"&&t.push({id:i.id,conditions:JSON.stringify(i.conditions),name:i.name})}),t},r.getSerializedAudiences=function(e,t){var n="";if(e){var i="";e.forEach(function(o){var s="";if(o instanceof Array)s="("+(s=r.getSerializedAudiences(o,t))+")";else if(W.indexOf(o)>-1)i=o.toUpperCase();else{var f=t[o]?t[o].name:o;n||i==="NOT"?(i=i===""?"OR":i,n=n===""?i+' "'+t[o].name+'"':n.concat(" "+i+' "'+f+'"')):n='"'+f+'"'}s!==""&&(n!==""||i==="NOT"?(i=i===""?"OR":i,n=n===""?i+" "+s:n.concat(" "+i+" "+s)):n=n.concat(s))})}return n},r.getExperimentAudiences=function(e,t){return e.audienceConditions?r.getSerializedAudiences(e.audienceConditions,t.audiencesById):""},r.mergeFeatureVariables=function(e,t,n,i,o){var s=(e[n]||[]).reduce(function(f,l){return f[l.key]={id:l.id,key:l.key,type:l.type,value:l.defaultValue},f},{});return(i||[]).forEach(function(f){var l=t[f.id],d={id:f.id,key:l.key,type:l.type,value:o?f.value:l.defaultValue};s[l.key]=d}),s},r.getVariationsMap=function(e,t,n,i){return e.reduce(function(o,s){var f=r.mergeFeatureVariables(t,n,i,s.variables,s.featureEnabled);return o[s.key]={id:s.id,key:s.key,featureEnabled:s.featureEnabled,variablesMap:f},o},{})},r.getVariableIdMap=function(e){return(e.featureFlags||[]).reduce(function(t,n){return n.variables.forEach(function(i){t[i.id]=i}),t},{})},r.getDeliveryRules=function(e,t,n,i){var o=r.getVariableIdMap(e);return i.map(function(s){return{id:s.id,key:s.key,audiences:r.getExperimentAudiences(s,e),variationsMap:r.getVariationsMap(s.variations,t,o,n)}})},r.getRolloutExperimentIds=function(e){var t=[];return(e||[]).forEach(function(n){n.experiments.forEach(function(i){t.push(i.id)})}),t},r.getExperimentsMapById=function(e,t){var n=r.getVariableIdMap(e),i=this.getRolloutExperimentIds(e.rollouts);return(e.experiments||[]).reduce(function(o,s){if(i.indexOf(s.id)===-1){var f=e.experimentFeatureMap[s.id],l="";f&&f.length>0&&(l=f[0]);var d=r.getVariationsMap(s.variations,t,n,l.toString());o[s.id]={id:s.id,key:s.key,audiences:r.getExperimentAudiences(s,e),variationsMap:d}}return o},{})},r.getExperimentsKeyMap=function(e){var t={};for(var n in e){var i=e[n];t[i.key]=i}return t},r.getFeaturesMap=function(e,t,n){var i={};return e.featureFlags.forEach(function(o){var s={},f=[];o.experimentIds.forEach(function(m){var V=n[m];V&&(s[V.key]=V),f.push(n[m])});var l=(o.variables||[]).reduce(function(m,V){return m[V.key]={id:V.id,key:V.key,type:V.type,value:V.defaultValue},m},{}),d=[],R=e.rolloutIdMap[o.rolloutId];R&&(d=r.getDeliveryRules(e,t,o.id,R.experiments)),i[o.key]={id:o.id,key:o.key,experimentRules:f,deliveryRules:d,experimentsMap:s,variablesMap:l}}),i},r}(),ie=Math.pow(2,53),K={assign:function(r){for(var e=[],t=1;t<arguments.length;t++)e[t-1]=arguments[t];if(!r)return{};if(typeof Object.assign=="function")return Object.assign.apply(Object,M([r],e));for(var n=Object(r),i=0;i<e.length;i++){var o=e[i];if(o!=null)for(var s in o)Object.prototype.hasOwnProperty.call(o,s)&&(n[s]=o[s])}return n},currentTimestamp:function(){return Math.round(new Date().getTime())},isSafeInteger:function(r){return typeof r=="number"&&Math.abs(r)<=ie},keyBy:function(r,e){return r?(0,h.keyBy)(r,function(t){return t[e]}):{}},uuid:h.generateUUID,isNumber:function(r){return typeof r=="number"}},ee="PROJECT_CONFIG",ve=c(function(r,e){e===void 0&&(e=null);var t,n,i,o,s=(t=r,(o=K.assign({},t)).audiences=(t.audiences||[]).map(function(f){return K.assign({},f)}),o.experiments=(t.experiments||[]).map(function(f){return K.assign({},f)}),o.featureFlags=(t.featureFlags||[]).map(function(f){return K.assign({},f)}),o.groups=(t.groups||[]).map(function(f){var l=K.assign({},f);return l.experiments=(f.experiments||[]).map(function(d){return K.assign({},d)}),l}),o.rollouts=(t.rollouts||[]).map(function(f){var l=K.assign({},f);return l.experiments=(f.experiments||[]).map(function(d){return K.assign({},d)}),l}),o.environmentKey=(n=t.environmentKey)!==null&&n!==void 0?n:"",o.sdkKey=(i=t.sdkKey)!==null&&i!==void 0?i:"",o);return s.__datafileStr=e===null?JSON.stringify(r):e,(s.audiences||[]).forEach(function(f){f.conditions=JSON.parse(f.conditions)}),s.audiencesById=K.keyBy(s.audiences,"id"),K.assign(s.audiencesById,K.keyBy(s.typedAudiences,"id")),s.attributeKeyMap=K.keyBy(s.attributes,"key"),s.eventKeyMap=K.keyBy(s.events,"key"),s.groupIdMap=K.keyBy(s.groups,"id"),Object.keys(s.groupIdMap||{}).forEach(function(f){(s.groupIdMap[f].experiments||[]).forEach(function(l){s.experiments.push(K.assign(l,{groupId:f}))})}),s.rolloutIdMap=K.keyBy(s.rollouts||[],"id"),(0,h.objectValues)(s.rolloutIdMap||{}).forEach(function(f){(f.experiments||[]).forEach(function(l){s.experiments.push(l),l.variationKeyMap=K.keyBy(l.variations,"key")})}),s.experimentKeyMap=K.keyBy(s.experiments,"key"),s.experimentIdMap=K.keyBy(s.experiments,"id"),s.variationIdMap={},s.variationVariableUsageMap={},(s.experiments||[]).forEach(function(f){f.variationKeyMap=K.keyBy(f.variations,"key"),K.assign(s.variationIdMap,K.keyBy(f.variations,"id")),(0,h.objectValues)(f.variationKeyMap||{}).forEach(function(l){l.variables&&(s.variationVariableUsageMap[l.id]=K.keyBy(l.variables,"id"))})}),s.experimentFeatureMap={},s.featureKeyMap=K.keyBy(s.featureFlags||[],"key"),(0,h.objectValues)(s.featureKeyMap||{}).forEach(function(f){f.variables.forEach(function(l){l.type===A.STRING&&l.subType===A.JSON&&(l.type=A.JSON,delete l.subType)}),f.variableKeyMap=K.keyBy(f.variables,"key"),(f.experimentIds||[]).forEach(function(l){s.experimentFeatureMap[l]?s.experimentFeatureMap[l].push(f.id):s.experimentFeatureMap[l]=[f.id]})}),s.flagRulesMap={},(s.featureFlags||[]).forEach(function(f){var l=[];f.experimentIds.forEach(function(R){var m=s.experimentIdMap[R];m&&l.push(m)});var d=s.rolloutIdMap[f.rolloutId];d&&l.push.apply(l,d.experiments),s.flagRulesMap[f.key]=l}),s.flagVariationsMap={},(0,h.objectEntries)(s.flagRulesMap||{}).forEach(function(f){var l=f[0],d=f[1],R=[];d.forEach(function(m){m.variations.forEach(function(V){(0,h.find)(R,function(j){return j.id===V.id})||R.push(V)})}),s.flagVariationsMap[l]=R}),s},"q"),Be=c(function(r,e){var t=r.experimentIdMap[e];if(!t)throw new Error((0,h.sprintf)(E.INVALID_EXPERIMENT_ID,ee,e));return t.layerId},"Q"),Ke=c(function(r,e,t){var n=r.attributeKeyMap[e],i=e.indexOf("$opt_")===0;return n?(i&&t.log(a.WARNING,"Attribute %s unexpectedly has reserved prefix %s; using attribute ID instead of reserved attribute name.",e,"$opt_"),n.id):i?e:(t.log(a.DEBUG,E.UNRECOGNIZED_ATTRIBUTE,ee,e),null)},"ee"),we=c(function(r,e){var t=r.eventKeyMap[e];return t?t.id:null},"te"),Ge=c(function(r,e){var t=r.experimentKeyMap[e];if(!t)throw new Error((0,h.sprintf)(E.INVALID_EXPERIMENT_KEY,ee,e));return t.status},"re"),je=c(function(r,e){return r.variationIdMap.hasOwnProperty(e)?r.variationIdMap[e].key:null},"ie"),Se=c(function(r,e){if(r.experimentKeyMap.hasOwnProperty(e)){var t=r.experimentKeyMap[e];if(t)return t}throw new Error((0,h.sprintf)(E.EXPERIMENT_KEY_NOT_IN_DATAFILE,ee,e))},"ne"),Et=c(function(r,e){var t=r.experimentIdMap[e];if(!t)throw new Error((0,h.sprintf)(E.INVALID_EXPERIMENT_ID,ee,e));return t.trafficAllocation},"oe"),dt=c(function(r,e,t){if(r.experimentIdMap.hasOwnProperty(e)){var n=r.experimentIdMap[e];if(n)return n}return t.log(a.ERROR,E.INVALID_EXPERIMENT_ID,ee,e),null},"ae"),He=c(function(r,e,t){if(!r)return null;var n=r.flagVariationsMap[e],i=(0,h.find)(n,function(o){return o.key===t});return i||null},"se"),Ce=c(function(r,e,t){if(r.featureKeyMap.hasOwnProperty(e)){var n=r.featureKeyMap[e];if(n)return n}return t.log(a.ERROR,E.FEATURE_NOT_IN_DATAFILE,ee,e),null},"ue"),Ye=c(function(r){return r.__datafileStr},"le"),ze=c(function(r){var e;try{e=he(r.datafile)}catch(n){return{configObj:null,error:n}}if(r.jsonSchemaValidator)try{r.jsonSchemaValidator.validate(e),r.logger.log(a.INFO,u.VALID_DATAFILE,ee)}catch(n){return{configObj:null,error:n}}else r.logger.log(a.INFO,u.SKIPPING_JSON_VALIDATION,ee);var t=[e];return typeof r.datafile=="string"&&t.push(r.datafile),{configObj:ve.apply(void 0,t),error:null}},"Ee"),Xe=c(function(r){return!!r.sendFlagDecisions},"Ie"),Ae=(0,O.getLogger)();function Re(r,e){return r instanceof Error?r.message:e||"Unknown error"}c(Re,"_e");var gt=function(){function r(e){this.updateListeners=[],this.configObj=null,this.optimizelyConfigObj=null,this.datafileManager=null;try{if(this.jsonSchemaValidator=e.jsonSchemaValidator,!e.datafile&&!e.sdkKey){var t=new Error((0,h.sprintf)(E.DATAFILE_AND_SDK_KEY_MISSING,"PROJECT_CONFIG_MANAGER"));return this.readyPromise=Promise.resolve({success:!1,reason:Re(t)}),void Ae.error(t)}var n=null;e.datafile&&(n=this.handleNewDatafile(e.datafile)),e.sdkKey&&e.datafileManager?(this.datafileManager=e.datafileManager,this.datafileManager.start(),this.readyPromise=this.datafileManager.onReady().then(this.onDatafileManagerReadyFulfill.bind(this),this.onDatafileManagerReadyReject.bind(this)),this.datafileManager.on("update",this.onDatafileManagerUpdate.bind(this))):this.configObj?this.readyPromise=Promise.resolve({success:!0}):this.readyPromise=Promise.resolve({success:!1,reason:Re(n,"Invalid datafile")})}catch(i){Ae.error(i),this.readyPromise=Promise.resolve({success:!1,reason:Re(i,"Error in initialize")})}}return c(r,"e"),r.prototype.onDatafileManagerReadyFulfill=function(){if(this.datafileManager){var e=this.handleNewDatafile(this.datafileManager.get());return e?{success:!1,reason:Re(e)}:{success:!0}}return{success:!1,reason:Re(null,"Datafile manager is not provided")}},r.prototype.onDatafileManagerReadyReject=function(e){return{success:!1,reason:Re(e,"Failed to become ready")}},r.prototype.onDatafileManagerUpdate=function(){this.datafileManager&&this.handleNewDatafile(this.datafileManager.get())},r.prototype.handleNewDatafile=function(e){var t=ze({datafile:e,jsonSchemaValidator:this.jsonSchemaValidator,logger:Ae}),n=t.configObj,i=t.error;if(i)Ae.error(i);else{var o=this.configObj?this.configObj.revision:"null";n&&o!==n.revision&&(this.configObj=n,this.optimizelyConfigObj=null,this.updateListeners.forEach(function(s){return s(n)}))}return i},r.prototype.getConfig=function(){return this.configObj},r.prototype.getOptimizelyConfig=function(){var e,t;return!this.optimizelyConfigObj&&this.configObj&&(this.optimizelyConfigObj=(e=this.configObj,t=Ye(this.configObj),new Q(e,t))),this.optimizelyConfigObj},r.prototype.onReady=function(){return this.readyPromise},r.prototype.onUpdate=function(e){var t=this;return this.updateListeners.push(e),function(){var n=t.updateListeners.indexOf(e);n>-1&&t.updateListeners.splice(n,1)}},r.prototype.stop=function(){this.datafileManager&&this.datafileManager.stop(),this.updateListeners=[]},r}(),pt=Math.pow(2,32),We=c(function(r){var e=[],t=r.experimentIdMap[r.experimentId].groupId;if(t){var n=r.groupIdMap[t];if(!n)throw new Error((0,h.sprintf)(E.INVALID_GROUP_ID,"BUCKETER",t));if(n.policy==="random"){var i=_t(n,r.bucketingId,r.userId,r.logger);if(i===null)return r.logger.log(a.INFO,u.USER_NOT_IN_ANY_EXPERIMENT,"BUCKETER",r.userId,t),e.push([u.USER_NOT_IN_ANY_EXPERIMENT,"BUCKETER",r.userId,t]),{result:null,reasons:e};if(i!==r.experimentId)return r.logger.log(a.INFO,u.USER_NOT_BUCKETED_INTO_EXPERIMENT_IN_GROUP,"BUCKETER",r.userId,r.experimentKey,t),e.push([u.USER_NOT_BUCKETED_INTO_EXPERIMENT_IN_GROUP,"BUCKETER",r.userId,r.experimentKey,t]),{result:null,reasons:e};r.logger.log(a.INFO,u.USER_BUCKETED_INTO_EXPERIMENT_IN_GROUP,"BUCKETER",r.userId,r.experimentKey,t),e.push([u.USER_BUCKETED_INTO_EXPERIMENT_IN_GROUP,"BUCKETER",r.userId,r.experimentKey,t])}}var o=""+r.bucketingId+r.experimentId,s=Ze(o);r.logger.log(a.DEBUG,u.USER_ASSIGNED_TO_EXPERIMENT_BUCKET,"BUCKETER",s,r.userId),e.push([u.USER_ASSIGNED_TO_EXPERIMENT_BUCKET,"BUCKETER",s,r.userId]);var f=Je(s,r.trafficAllocationConfig);return f===null||r.variationIdMap[f]?{result:f,reasons:e}:(f&&(r.logger.log(a.WARNING,u.INVALID_VARIATION_ID,"BUCKETER"),e.push([u.INVALID_VARIATION_ID,"BUCKETER"])),{result:null,reasons:e})},"ge"),_t=c(function(r,e,t,n){var i=""+e+r.id,o=Ze(i);n.log(a.DEBUG,u.USER_ASSIGNED_TO_EXPERIMENT_BUCKET,"BUCKETER",o,t);var s=r.trafficAllocation;return Je(o,s)},"pe"),Je=c(function(r,e){for(var t=0;t<e.length;t++)if(r<e[t].endOfRange)return e[t].entityId;return null},"Ne"),Ze=c(function(r){try{var e=L().v3(r,1)/pt;return Math.floor(1e4*e)}catch(t){throw new Error((0,h.sprintf)(E.INVALID_BUCKETING_ID,"BUCKETER",r,t.message))}},"Re"),me=(0,O.getLogger)();function qe(r){return/^\d+$/.test(r)}c(qe,"Te");function pe(r){var e=r.indexOf("-"),t=r.indexOf("+");return!(e<0)&&(t<0||e<t)}c(pe,"ve");function Qe(r){var e=r.indexOf("-"),t=r.indexOf("+");return!(t<0)&&(e<0||t<e)}c(Qe,"he");function $e(r){var e=r,t="";if(function(f){return/\s/.test(f)}(r))return me.warn(u.UNKNOWN_MATCH_TYPE,"SEMANTIC VERSION",r),null;if(pe(r)?(e=r.substring(0,r.indexOf("-")),t=r.substring(r.indexOf("-")+1)):Qe(r)&&(e=r.substring(0,r.indexOf("+")),t=r.substring(r.indexOf("+")+1)),typeof e!="string"||typeof t!="string")return null;var n=e.split(".").length-1;if(n>2)return me.warn(u.UNKNOWN_MATCH_TYPE,"SEMANTIC VERSION",r),null;var i=e.split(".");if(i.length!=n+1)return me.warn(u.UNKNOWN_MATCH_TYPE,"SEMANTIC VERSION",r),null;for(var o=0,s=i;o<s.length;o++)if(!qe(s[o]))return me.warn(u.UNKNOWN_MATCH_TYPE,"SEMANTIC VERSION",r),null;return t&&i.push(t),i}c($e,"ye");var oe="CUSTOM_ATTRIBUTE_CONDITION_EVALUATOR",ae=(0,O.getLogger)(),It=["exact","exists","gt","ge","lt","le","substring","semver_eq","semver_lt","semver_le","semver_gt","semver_ge"],fe={};function et(r){return typeof r=="string"||typeof r=="boolean"||K.isNumber(r)}c(et,"Le");function tt(r,e){var t=r.value,n=typeof t,i=r.name,o=e[i],s=typeof o;return!et(t)||K.isNumber(t)&&!K.isSafeInteger(t)?(ae.warn(u.UNEXPECTED_CONDITION_VALUE,oe,JSON.stringify(r)),null):o===null?(ae.debug(u.UNEXPECTED_TYPE_NULL,oe,JSON.stringify(r),i),null):et(o)&&n===s?K.isNumber(o)&&!K.isSafeInteger(o)?(ae.warn(u.OUT_OF_BOUNDS,oe,JSON.stringify(r),i),null):t===o:(ae.warn(u.UNEXPECTED_TYPE,oe,JSON.stringify(r),s,i),null)}c(tt,"me");function Le(r,e){var t=r.name,n=e[t],i=typeof n,o=r.value;return o!==null&&K.isSafeInteger(o)?n===null?(ae.debug(u.UNEXPECTED_TYPE_NULL,oe,JSON.stringify(r),t),!1):K.isNumber(n)?!!K.isSafeInteger(n)||(ae.warn(u.OUT_OF_BOUNDS,oe,JSON.stringify(r),t),!1):(ae.warn(u.UNEXPECTED_TYPE,oe,JSON.stringify(r),i,t),!1):(ae.warn(u.UNEXPECTED_CONDITION_VALUE,oe,JSON.stringify(r)),!1)}c(Le,"Ve");function ye(r,e){var t=r.name,n=e[t],i=typeof n,o=r.value;return typeof o!="string"?(ae.warn(u.UNEXPECTED_CONDITION_VALUE,oe,JSON.stringify(r)),null):n===null?(ae.debug(u.UNEXPECTED_TYPE_NULL,oe,JSON.stringify(r),t),null):typeof n!="string"?(ae.warn(u.UNEXPECTED_TYPE,oe,JSON.stringify(r),i,t),null):function(s,f){var l=$e(f),d=$e(s);if(!l||!d)return null;for(var R=l.length,m=0;m<d.length;m++){if(R<=m)return pe(s)||Qe(s)?1:-1;if(qe(l[m])){var V=parseInt(l[m]),j=parseInt(d[m]);if(V>j)return 1;if(V<j)return-1}else{if(l[m]<d[m])return pe(s)&&!pe(f)?1:-1;if(l[m]>d[m])return!pe(s)&&pe(f)?-1:1}}return pe(f)&&!pe(s)?-1:0}(o,n)}c(ye,"Ce"),fe.exact=tt,fe.exists=function(r,e){var t=e[r.name];return t!=null},fe.gt=function(r,e){var t=e[r.name],n=r.value;return!Le(r,e)||n===null?null:t>n},fe.ge=function(r,e){var t=e[r.name],n=r.value;return!Le(r,e)||n===null?null:t>=n},fe.lt=function(r,e){var t=e[r.name],n=r.value;return!Le(r,e)||n===null?null:t<n},fe.le=function(r,e){var t=e[r.name],n=r.value;return!Le(r,e)||n===null?null:t<=n},fe.substring=function(r,e){var t=r.name,n=e[r.name],i=typeof n,o=r.value;return typeof o!="string"?(ae.warn(u.UNEXPECTED_CONDITION_VALUE,oe,JSON.stringify(r)),null):n===null?(ae.debug(u.UNEXPECTED_TYPE_NULL,oe,JSON.stringify(r),t),null):typeof n!="string"?(ae.warn(u.UNEXPECTED_TYPE,oe,JSON.stringify(r),i,t),null):n.indexOf(o)!==-1},fe.semver_eq=function(r,e){var t=ye(r,e);return t===null?null:t===0},fe.semver_gt=function(r,e){var t=ye(r,e);return t===null?null:t>0},fe.semver_ge=function(r,e){var t=ye(r,e);return t===null?null:t>=0},fe.semver_lt=function(r,e){var t=ye(r,e);return t===null?null:t<0},fe.semver_le=function(r,e){var t=ye(r,e);return t===null?null:t<=0};var ht=Object.freeze({__proto__:null,evaluate:function(r,e){var t=r.match;if(t!==void 0&&It.indexOf(t)===-1)return ae.warn(u.UNKNOWN_MATCH_TYPE,oe,JSON.stringify(r)),null;var n=r.name;return e.hasOwnProperty(n)||t=="exists"?(t&&fe[t]||tt)(r,e):(ae.debug(u.MISSING_ATTRIBUTE_VALUE,oe,JSON.stringify(r),n),null)}}),De=(0,O.getLogger)(),vt=function(){function r(e){this.typeToEvaluatorMap=K.assign({},e,{custom_attribute:ht})}return c(r,"e"),r.prototype.evaluate=function(e,t,n){var i=this;return n===void 0&&(n={}),!e||e.length===0?!0:!!J(e,function(o){var s=t[o];if(s){De.log(a.DEBUG,u.EVALUATING_AUDIENCE,"AUDIENCE_EVALUATOR",o,JSON.stringify(s.conditions));var f=J(s.conditions,i.evaluateConditionWithUserAttributes.bind(i,n)),l=f===null?"UNKNOWN":f.toString().toUpperCase();return De.log(a.DEBUG,u.AUDIENCE_EVALUATION_RESULT,"AUDIENCE_EVALUATOR",o,l),f}return null})},r.prototype.evaluateConditionWithUserAttributes=function(e,t){var n=this.typeToEvaluatorMap[t.type];if(!n)return De.log(a.WARNING,u.UNKNOWN_CONDITION_TYPE,"AUDIENCE_EVALUATOR",JSON.stringify(t)),null;try{return n.evaluate(t,e)}catch(i){De.log(a.ERROR,E.CONDITION_EVALUATOR_ERROR,"AUDIENCE_EVALUATOR",t.type,i.message)}return null},r}();function rt(r){return typeof r=="string"&&r!==""}c(rt,"be");var w="DECISION_SERVICE",Rt=function(){function r(e){var t;this.audienceEvaluator=(t=e.UNSTABLE_conditionEvaluators,new vt(t)),this.forcedVariationMap={},this.logger=e.logger,this.userProfileService=e.userProfileService||null}return c(r,"e"),r.prototype.getVariation=function(e,t,n,i){i===void 0&&(i={});var o=n.getUserId(),s=n.getAttributes(),f=this.getBucketingId(o,s),l=[],d=t.key;if(!this.checkIfExperimentIsActive(e,d))return this.logger.log(a.INFO,u.EXPERIMENT_NOT_RUNNING,w,d),l.push([u.EXPERIMENT_NOT_RUNNING,w,d]),{result:null,reasons:l};var R=this.getForcedVariation(e,d,o);l.push.apply(l,R.reasons);var m=R.result;if(m)return{result:m,reasons:l};var V=this.getWhitelistedVariation(t,o);l.push.apply(l,V.reasons);var j=V.result;if(j)return{result:j.key,reasons:l};var $=i[G.IGNORE_USER_PROFILE_SERVICE],ne=this.resolveExperimentBucketMap(o,s);if(!$&&(j=this.getStoredVariation(e,t,o,ne)))return this.logger.log(a.INFO,u.RETURNING_STORED_VARIATION,w,j.key,d,o),l.push([u.RETURNING_STORED_VARIATION,w,j.key,d,o]),{result:j.key,reasons:l};var te=this.checkIfUserIsInAudience(e,t,b.EXPERIMENT,s,"");if(l.push.apply(l,te.reasons),!te.result)return this.logger.log(a.INFO,u.USER_NOT_IN_EXPERIMENT,w,o,d),l.push([u.USER_NOT_IN_EXPERIMENT,w,o,d]),{result:null,reasons:l};var se=this.buildBucketerParams(e,t,f,o),ce=We(se);l.push.apply(l,ce.reasons);var ue=ce.result;return ue&&(j=e.variationIdMap[ue]),j?(this.logger.log(a.INFO,u.USER_HAS_VARIATION,w,o,j.key,d),l.push([u.USER_HAS_VARIATION,w,o,j.key,d]),$||this.saveUserProfile(t,j,o,ne),{result:j.key,reasons:l}):(this.logger.log(a.DEBUG,u.USER_HAS_NO_VARIATION,w,o,d),l.push([u.USER_HAS_NO_VARIATION,w,o,d]),{result:null,reasons:l})},r.prototype.resolveExperimentBucketMap=function(e,t){t=t||{};var n=this.getUserProfile(e)||{},i=t[p.STICKY_BUCKETING_KEY];return K.assign({},n.experiment_bucket_map,i)},r.prototype.checkIfExperimentIsActive=function(e,t){return function(n,i){return Ge(n,i)==="Running"}(e,t)},r.prototype.getWhitelistedVariation=function(e,t){var n=[];if(e.forcedVariations&&e.forcedVariations.hasOwnProperty(t)){var i=e.forcedVariations[t];return e.variationKeyMap.hasOwnProperty(i)?(this.logger.log(a.INFO,u.USER_FORCED_IN_VARIATION,w,t,i),n.push([u.USER_FORCED_IN_VARIATION,w,t,i]),{result:e.variationKeyMap[i],reasons:n}):(this.logger.log(a.ERROR,u.FORCED_BUCKETING_FAILED,w,i,t),n.push([u.FORCED_BUCKETING_FAILED,w,i,t]),{result:null,reasons:n})}return{result:null,reasons:n}},r.prototype.checkIfUserIsInAudience=function(e,t,n,i,o){var s=[],f=function(R,m){var V=R.experimentIdMap[m];if(!V)throw new Error((0,h.sprintf)(E.INVALID_EXPERIMENT_ID,ee,m));return V.audienceConditions||V.audienceIds}(e,t.id),l=e.audiencesById;this.logger.log(a.DEBUG,u.EVALUATING_AUDIENCES_COMBINED,w,n,o||t.key,JSON.stringify(f)),s.push([u.EVALUATING_AUDIENCES_COMBINED,w,n,o||t.key,JSON.stringify(f)]);var d=this.audienceEvaluator.evaluate(f,l,i);return this.logger.log(a.INFO,u.AUDIENCE_EVALUATION_RESULT_COMBINED,w,n,o||t.key,d.toString().toUpperCase()),s.push([u.AUDIENCE_EVALUATION_RESULT_COMBINED,w,n,o||t.key,d.toString().toUpperCase()]),{result:d,reasons:s}},r.prototype.buildBucketerParams=function(e,t,n,i){return{bucketingId:n,experimentId:t.id,experimentKey:t.key,experimentIdMap:e.experimentIdMap,experimentKeyMap:e.experimentKeyMap,groupIdMap:e.groupIdMap,logger:this.logger,trafficAllocationConfig:Et(e,t.id),userId:i,variationIdMap:e.variationIdMap}},r.prototype.getStoredVariation=function(e,t,n,i){if(i.hasOwnProperty(t.id)){var o=i[t.id],s=o.variation_id;if(e.variationIdMap.hasOwnProperty(s))return e.variationIdMap[o.variation_id];this.logger.log(a.INFO,u.SAVED_VARIATION_NOT_FOUND,w,n,s,t.key)}return null},r.prototype.getUserProfile=function(e){var t={user_id:e,experiment_bucket_map:{}};if(!this.userProfileService)return t;try{return this.userProfileService.lookup(e)}catch(n){this.logger.log(a.ERROR,E.USER_PROFILE_LOOKUP_ERROR,w,e,n.message)}return null},r.prototype.saveUserProfile=function(e,t,n,i){if(this.userProfileService)try{i[e.id]={variation_id:t.id},this.userProfileService.save({user_id:n,experiment_bucket_map:i}),this.logger.log(a.INFO,u.SAVED_VARIATION,w,t.key,e.key,n)}catch(o){this.logger.log(a.ERROR,E.USER_PROFILE_SAVE_ERROR,w,n,o.message)}},r.prototype.getVariationForFeature=function(e,t,n,i){i===void 0&&(i={});var o=[],s=this.getVariationForFeatureExperiment(e,t,n,i);o.push.apply(o,s.reasons);var f=s.result;if(f.variation!==null)return{result:f,reasons:o};var l=this.getVariationForRollout(e,t,n);o.push.apply(o,l.reasons);var d=l.result,R=n.getUserId();return d.variation?(this.logger.log(a.DEBUG,u.USER_IN_ROLLOUT,w,R,t.key),o.push([u.USER_IN_ROLLOUT,w,R,t.key]),{result:d,reasons:o}):(this.logger.log(a.DEBUG,u.USER_NOT_IN_ROLLOUT,w,R,t.key),o.push([u.USER_NOT_IN_ROLLOUT,w,R,t.key]),{result:d,reasons:o})},r.prototype.getVariationForFeatureExperiment=function(e,t,n,i){i===void 0&&(i={});var o,s,f=[],l=null;if(t.experimentIds.length>0)for(s=0;s<t.experimentIds.length;s++){var d=dt(e,t.experimentIds[s],this.logger);if(d&&(o=this.getVariationFromExperimentRule(e,t.key,d,n,i),f.push.apply(f,o.reasons),l=o.result)){var R=null;return(R=d.variationKeyMap[l])||(R=He(e,t.key,l)),{result:{experiment:d,variation:R,decisionSource:F.FEATURE_TEST},reasons:f}}}else this.logger.log(a.DEBUG,u.FEATURE_HAS_NO_EXPERIMENTS,w,t.key),f.push([u.FEATURE_HAS_NO_EXPERIMENTS,w,t.key]);return{result:{experiment:null,variation:null,decisionSource:F.FEATURE_TEST},reasons:f}},r.prototype.getVariationForRollout=function(e,t,n){var i=[];if(!t.rolloutId)return this.logger.log(a.DEBUG,u.NO_ROLLOUT_EXISTS,w,t.key),i.push([u.NO_ROLLOUT_EXISTS,w,t.key]),{result:{experiment:null,variation:null,decisionSource:F.ROLLOUT},reasons:i};var o=e.rolloutIdMap[t.rolloutId];if(!o)return this.logger.log(a.ERROR,E.INVALID_ROLLOUT_ID,w,t.rolloutId,t.key),i.push([E.INVALID_ROLLOUT_ID,w,t.rolloutId,t.key]),{result:{experiment:null,variation:null,decisionSource:F.ROLLOUT},reasons:i};var s,f,l,d=o.experiments;if(d.length===0)return this.logger.log(a.ERROR,u.ROLLOUT_HAS_NO_EXPERIMENTS,w,t.rolloutId),i.push([u.ROLLOUT_HAS_NO_EXPERIMENTS,w,t.rolloutId]),{result:{experiment:null,variation:null,decisionSource:F.ROLLOUT},reasons:i};for(var R=0;R<d.length;){if(s=this.getVariationFromDeliveryRule(e,t.key,d,R,n),i.push.apply(i,s.reasons),l=s.result,f=s.skipToEveryoneElse,l)return{result:{experiment:e.experimentIdMap[d[R].id],variation:l,decisionSource:F.ROLLOUT},reasons:i};R=f?d.length-1:R+1}return{result:{experiment:null,variation:null,decisionSource:F.ROLLOUT},reasons:i}},r.prototype.getBucketingId=function(e,t){var n=e;return t!=null&&typeof t=="object"&&t.hasOwnProperty(p.BUCKETING_ID)&&(typeof t[p.BUCKETING_ID]=="string"?(n=t[p.BUCKETING_ID],this.logger.log(a.DEBUG,u.VALID_BUCKETING_ID,w,n)):this.logger.log(a.WARNING,u.BUCKETING_ID_NOT_STRING,w)),n},r.prototype.findValidatedForcedDecision=function(e,t,n,i){var o,s=[],f=t.getForcedDecision({flagKey:n,ruleKey:i}),l=null,d=t.getUserId();return e&&f&&(o=f.variationKey,(l=He(e,n,o))?i?(this.logger.log(a.INFO,u.USER_HAS_FORCED_DECISION_WITH_RULE_SPECIFIED,o,n,i,d),s.push([u.USER_HAS_FORCED_DECISION_WITH_RULE_SPECIFIED,o,n,i,d])):(this.logger.log(a.INFO,u.USER_HAS_FORCED_DECISION_WITH_NO_RULE_SPECIFIED,o,n,d),s.push([u.USER_HAS_FORCED_DECISION_WITH_NO_RULE_SPECIFIED,o,n,d])):i?(this.logger.log(a.INFO,u.USER_HAS_FORCED_DECISION_WITH_RULE_SPECIFIED_BUT_INVALID,n,i,d),s.push([u.USER_HAS_FORCED_DECISION_WITH_RULE_SPECIFIED_BUT_INVALID,n,i,d])):(this.logger.log(a.INFO,u.USER_HAS_FORCED_DECISION_WITH_NO_RULE_SPECIFIED_BUT_INVALID,n,d),s.push([u.USER_HAS_FORCED_DECISION_WITH_NO_RULE_SPECIFIED_BUT_INVALID,n,d]))),{result:l,reasons:s}},r.prototype.removeForcedVariation=function(e,t,n){if(!e)throw new Error((0,h.sprintf)(E.INVALID_USER_ID,w));if(!this.forcedVariationMap.hasOwnProperty(e))throw new Error((0,h.sprintf)(E.USER_NOT_IN_FORCED_VARIATION,w,e));delete this.forcedVariationMap[e][t],this.logger.log(a.DEBUG,u.VARIATION_REMOVED_FOR_USER,w,n,e)},r.prototype.setInForcedVariationMap=function(e,t,n){this.forcedVariationMap.hasOwnProperty(e)||(this.forcedVariationMap[e]={}),this.forcedVariationMap[e][t]=n,this.logger.log(a.DEBUG,u.USER_MAPPED_TO_FORCED_VARIATION,w,n,t,e)},r.prototype.getForcedVariation=function(e,t,n){var i,o=[],s=this.forcedVariationMap[n];if(!s)return this.logger.log(a.DEBUG,u.USER_HAS_NO_FORCED_VARIATION,w,n),{result:null,reasons:o};try{var f=Se(e,t);if(!f.hasOwnProperty("id"))return this.logger.log(a.ERROR,E.IMPROPERLY_FORMATTED_EXPERIMENT,w,t),o.push([E.IMPROPERLY_FORMATTED_EXPERIMENT,w,t]),{result:null,reasons:o};i=f.id}catch(R){return this.logger.log(a.ERROR,R.message),o.push(R.message),{result:null,reasons:o}}var l=s[i];if(!l)return this.logger.log(a.DEBUG,u.USER_HAS_NO_FORCED_VARIATION_FOR_EXPERIMENT,w,t,n),{result:null,reasons:o};var d=je(e,l);return d?(this.logger.log(a.DEBUG,u.USER_HAS_FORCED_VARIATION,w,d,t,n),o.push([u.USER_HAS_FORCED_VARIATION,w,d,t,n])):this.logger.log(a.DEBUG,u.USER_HAS_NO_FORCED_VARIATION_FOR_EXPERIMENT,w,t,n),{result:d,reasons:o}},r.prototype.setForcedVariation=function(e,t,n,i){if(i!=null&&!rt(i))return this.logger.log(a.ERROR,E.INVALID_VARIATION_KEY,w),!1;var o;try{var s=Se(e,t);if(!s.hasOwnProperty("id"))return this.logger.log(a.ERROR,E.IMPROPERLY_FORMATTED_EXPERIMENT,w,t),!1;o=s.id}catch(l){return this.logger.log(a.ERROR,l.message),!1}if(i==null)try{return this.removeForcedVariation(n,o,t),!0}catch(l){return this.logger.log(a.ERROR,l.message),!1}var f=function(l,d,R){var m=l.experimentKeyMap[d];return m.variationKeyMap.hasOwnProperty(R)?m.variationKeyMap[R].id:null}(e,t,i);if(!f)return this.logger.log(a.ERROR,E.NO_VARIATION_FOR_EXPERIMENT_KEY,w,i,t),!1;try{return this.setInForcedVariationMap(n,o,f),!0}catch(l){return this.logger.log(a.ERROR,l.message),!1}},r.prototype.getVariationFromExperimentRule=function(e,t,n,i,o){o===void 0&&(o={});var s=[],f=this.findValidatedForcedDecision(e,i,t,n.key);s.push.apply(s,f.reasons);var l=f.result;if(l)return{result:l.key,reasons:s};var d=this.getVariation(e,n,i,o);return s.push.apply(s,d.reasons),{result:d.result,reasons:s}},r.prototype.getVariationFromDeliveryRule=function(e,t,n,i,o){var s=[],f=!1,l=n[i],d=this.findValidatedForcedDecision(e,o,t,l.key);s.push.apply(s,d.reasons);var R=d.result;if(R)return{result:R,reasons:s,skipToEveryoneElse:f};var m,V,j,$,ne,te=o.getUserId(),se=o.getAttributes(),ce=this.getBucketingId(te,se),ue=i===n.length-1,le=ue?"Everyone Else":i+1,Ie=null,de=this.checkIfUserIsInAudience(e,l,b.RULE,se,le);return s.push.apply(s,de.reasons),de.result?(this.logger.log(a.DEBUG,u.USER_MEETS_CONDITIONS_FOR_TARGETING_RULE,w,te,le),s.push([u.USER_MEETS_CONDITIONS_FOR_TARGETING_RULE,w,te,le]),V=this.buildBucketerParams(e,l,ce,te),j=We(V),s.push.apply(s,j.reasons),(m=j.result)&&(ne=m,Ie=($=e).variationIdMap.hasOwnProperty(ne)?$.variationIdMap[ne]:null),Ie?(this.logger.log(a.DEBUG,u.USER_BUCKETED_INTO_TARGETING_RULE,w,te,le),s.push([u.USER_BUCKETED_INTO_TARGETING_RULE,w,te,le])):ue||(this.logger.log(a.DEBUG,u.USER_NOT_BUCKETED_INTO_TARGETING_RULE,w,te,le),s.push([u.USER_NOT_BUCKETED_INTO_TARGETING_RULE,w,te,le]),f=!0)):(this.logger.log(a.DEBUG,u.USER_DOESNT_MEET_CONDITIONS_FOR_TARGETING_RULE,w,te,le),s.push([u.USER_DOESNT_MEET_CONDITIONS_FOR_TARGETING_RULE,w,te,le])),{result:Ie,reasons:s,skipToEveryoneElse:f}},r}();function nt(r,e){if(r.hasOwnProperty("revenue")){var t=r.revenue,n=void 0;return typeof t=="string"?(n=parseInt(t),isNaN(n)?(e.log(a.INFO,u.FAILED_TO_PARSE_REVENUE,"EVENT_TAG_UTILS",t),null):(e.log(a.INFO,u.PARSED_REVENUE_VALUE,"EVENT_TAG_UTILS",n),n)):typeof t=="number"?(n=t,e.log(a.INFO,u.PARSED_REVENUE_VALUE,"EVENT_TAG_UTILS",n),n):null}return null}c(nt,"Ke");function it(r,e){if(r.hasOwnProperty("value")){var t=r.value,n=void 0;return typeof t=="string"?(n=parseFloat(t),isNaN(n)?(e.log(a.INFO,u.FAILED_TO_PARSE_VALUE,"EVENT_TAG_UTILS",t),null):(e.log(a.INFO,u.PARSED_NUMERIC_VALUE,"EVENT_TAG_UTILS",n),n)):typeof t=="number"?(n=t,e.log(a.INFO,u.PARSED_NUMERIC_VALUE,"EVENT_TAG_UTILS",n),n):null}return null}c(it,"xe");function ot(r,e){return typeof r=="string"&&(typeof e=="string"||typeof e=="boolean"||K.isNumber(e)&&K.isSafeInteger(e))}c(ot,"Ge");var at="https://logx.optimizely.com/v1/events";function st(r){var e=r.attributes,t=r.userId,n=r.clientEngine,i=r.clientVersion,o=r.configObj,s=r.logger,f=!!o.anonymizeIP&&o.anonymizeIP,l=o.botFiltering,d={snapshots:[],visitor_id:t,attributes:[]},R={account_id:o.accountId,project_id:o.projectId,visitors:[d],revision:o.revision,client_name:n,client_version:i,anonymize_ip:f,enrich_decisions:!0};return e&&Object.keys(e||{}).forEach(function(m){if(ot(m,e[m])){var V=Ke(o,m,s);V&&R.visitors[0].attributes.push({entity_id:V,key:m,type:"custom",value:e[m]})}}),typeof l=="boolean"&&R.visitors[0].attributes.push({entity_id:p.BOT_FILTERING,key:p.BOT_FILTERING,type:"custom",value:l}),R}c(st,"je");function Ot(r){var e,t,n,i,o,s,f,l,d,R=st(r),m=(e=r.configObj,t=r.experimentId,n=r.variationId,i=r.ruleKey,o=r.ruleType,s=r.flagKey,f=r.enabled,l=t?Be(e,t):null,d=n?je(e,n):null,{decisions:[{campaign_id:l,experiment_id:t,variation_id:n,metadata:{flag_key:s,rule_key:i,rule_type:o,variation_key:d=d||"",enabled:f}}],events:[{entity_id:l,timestamp:K.currentTimestamp(),key:"campaign_activated",uuid:K.uuid()}]});return R.visitors[0].snapshots.push(m),{httpVerb:"POST",url:at,params:R}}c(Ot,"Ye");function yt(r){var e=st(r),t=function(n,i,o,s){var f={events:[]},l={entity_id:we(n,i),timestamp:K.currentTimestamp(),uuid:K.uuid(),key:i};if(s){var d=nt(s,o);d!==null&&(l.revenue=d);var R=it(s,o);R!==null&&(l.value=R),l.tags=s}return f.events.push(l),f}(r.configObj,r.eventKey,r.logger,r.eventTags);return e.visitors[0].snapshots=[t],{httpVerb:"POST",url:at,params:e}}c(yt,"He");function Ve(r){var e,t;return(t=(e=r.experiment)===null||e===void 0?void 0:e.key)!==null&&t!==void 0?t:""}c(Ve,"Xe");function be(r){var e,t;return(t=(e=r.variation)===null||e===void 0?void 0:e.key)!==null&&t!==void 0?t:""}c(be,"Je");function Ue(r){var e,t;return(t=(e=r.variation)===null||e===void 0?void 0:e.featureEnabled)!==null&&t!==void 0&&t}c(Ue,"ze");function ut(r){var e,t;return(t=(e=r.experiment)===null||e===void 0?void 0:e.id)!==null&&t!==void 0?t:null}c(ut,"Ze");function lt(r){var e,t;return(t=(e=r.variation)===null||e===void 0?void 0:e.id)!==null&&t!==void 0?t:null}c(lt,"We");var Pe=(0,O.getLogger)("EVENT_BUILDER");function ft(r,e){var t=[];return e&&Object.keys(e||{}).forEach(function(n){if(ot(n,e[n])){var i=Ke(r,n,Pe);i&&t.push({entityId:i,key:n,value:e[n]})}}),t}c(ft,"qe");var Me="USER_PROFILE_SERVICE_VALIDATOR",Tt=function(){function r(e){var t,n=this,i=e.clientEngine;i||(e.logger.log(a.INFO,u.INVALID_CLIENT_ENGINE,"OPTIMIZELY",i),i="node-sdk"),this.clientEngine=i,this.clientVersion=e.clientVersion||"4.9.1",this.errorHandler=e.errorHandler,this.isOptimizelyConfigValid=e.isValidInstance,this.logger=e.logger;var o=(t=e.defaultDecideOptions)!==null&&t!==void 0?t:[];Array.isArray(o)||(this.logger.log(a.DEBUG,u.INVALID_DEFAULT_DECIDE_OPTIONS,"OPTIMIZELY"),o=[]);var s={};o.forEach(function(m){G[m]?s[m]=!0:n.logger.log(a.WARNING,u.UNRECOGNIZED_DECIDE_OPTION,"OPTIMIZELY",m)}),this.defaultDecideOptions=s,this.projectConfigManager=function(m){return new gt(m)}({datafile:e.datafile,jsonSchemaValidator:e.jsonSchemaValidator,sdkKey:e.sdkKey,datafileManager:e.datafileManager}),this.disposeOnUpdate=this.projectConfigManager.onUpdate(function(m){n.logger.log(a.INFO,u.UPDATED_OPTIMIZELY_CONFIG,"OPTIMIZELY",m.revision,m.projectId),n.notificationCenter.sendNotifications(_.OPTIMIZELY_CONFIG_UPDATE)});var f,l=this.projectConfigManager.onReady(),d=null;if(e.userProfileService)try{(function(m){if(typeof m=="object"&&m!==null){if(typeof m.lookup!="function")throw new Error((0,h.sprintf)(E.INVALID_USER_PROFILE_SERVICE,Me,"Missing function 'lookup'"));if(typeof m.save!="function")throw new Error((0,h.sprintf)(E.INVALID_USER_PROFILE_SERVICE,Me,"Missing function 'save'"));return!0}throw new Error((0,h.sprintf)(E.INVALID_USER_PROFILE_SERVICE,Me))})(e.userProfileService)&&(d=e.userProfileService,this.logger.log(a.INFO,u.VALID_USER_PROFILE_SERVICE,"OPTIMIZELY"))}catch(m){this.logger.log(a.WARNING,m.message)}this.decisionService=(f={userProfileService:d,logger:this.logger,UNSTABLE_conditionEvaluators:e.UNSTABLE_conditionEvaluators},new Rt(f)),this.notificationCenter=e.notificationCenter,this.eventProcessor=e.eventProcessor;var R=this.eventProcessor.start();this.readyPromise=Promise.all([l,R]).then(function(m){return m[0]}),this.readyTimeouts={},this.nextReadyTimeoutId=0}return c(r,"e"),r.prototype.isValidInstance=function(){return this.isOptimizelyConfigValid&&!!this.projectConfigManager.getConfig()},r.prototype.activate=function(e,t,n){try{if(!this.isValidInstance())return this.logger.log(a.ERROR,u.INVALID_OBJECT,"OPTIMIZELY","activate"),null;if(!this.validateInputs({experiment_key:e,user_id:t},n))return this.notActivatingExperiment(e,t);var i=this.projectConfigManager.getConfig();if(!i)return null;try{var o=this.getVariation(e,t,n);if(o===null)return this.notActivatingExperiment(e,t);if(!function(l,d){return Ge(l,d)==="Running"}(i,e))return this.logger.log(a.DEBUG,u.SHOULD_NOT_DISPATCH_ACTIVATE,"OPTIMIZELY",e),o;var s=Se(i,e),f={experiment:s,variation:s.variationKeyMap[o],decisionSource:F.EXPERIMENT};return this.sendImpressionEvent(f,"",t,!0,n),o}catch(l){return this.logger.log(a.ERROR,l.message),this.logger.log(a.INFO,u.NOT_ACTIVATING_USER,"OPTIMIZELY",t,e),this.errorHandler.handleError(l),null}}catch(l){return this.logger.log(a.ERROR,l.message),this.errorHandler.handleError(l),null}},r.prototype.sendImpressionEvent=function(e,t,n,i,o){var s=this.projectConfigManager.getConfig();if(s){var f=function(l){var d=l.configObj,R=l.decisionObj,m=l.userId,V=l.flagKey,j=l.enabled,$=l.userAttributes,ne=l.clientEngine,te=l.clientVersion,se=R.decisionSource,ce=Ve(R),ue=ut(R),le=be(R),Ie=lt(R),de=ue!==null?Be(d,ue):null;return{type:"impression",timestamp:K.currentTimestamp(),uuid:K.uuid(),user:{id:m,attributes:ft(d,$)},context:{accountId:d.accountId,projectId:d.projectId,revision:d.revision,clientName:ne,clientVersion:te,anonymizeIP:d.anonymizeIP||!1,botFiltering:d.botFiltering},layer:{id:de},experiment:{id:ue,key:ce},variation:{id:Ie,key:le},ruleKey:ce,flagKey:V,ruleType:se,enabled:j}}({decisionObj:e,flagKey:t,enabled:i,userId:n,userAttributes:o,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:s});this.eventProcessor.process(f),this.emitNotificationCenterActivate(e,t,n,i,o)}},r.prototype.emitNotificationCenterActivate=function(e,t,n,i,o){var s=this.projectConfigManager.getConfig();if(s){var f,l=e.decisionSource,d=Ve(e),R=ut(e),m=be(e),V=lt(e);R!==null&&m!==""&&(f=s.experimentIdMap[R]);var j,$=Ot({attributes:o,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:s,experimentId:R,ruleKey:d,flagKey:t,ruleType:l,userId:n,enabled:i,variationId:V,logger:this.logger});f&&f.variationKeyMap&&m!==""&&(j=f.variationKeyMap[m]),this.notificationCenter.sendNotifications(_.ACTIVATE,{experiment:f,userId:n,attributes:o,variation:j,logEvent:$})}},r.prototype.track=function(e,t,n,i){try{if(!this.isValidInstance())return void this.logger.log(a.ERROR,u.INVALID_OBJECT,"OPTIMIZELY","track");if(!this.validateInputs({user_id:t,event_key:e},n,i))return;var o=this.projectConfigManager.getConfig();if(!o)return;if(!function(f,l){return f.eventKeyMap.hasOwnProperty(l)}(o,e))return this.logger.log(a.WARNING,u.EVENT_KEY_NOT_FOUND,"OPTIMIZELY",e),void this.logger.log(a.WARNING,u.NOT_TRACKING_USER,"OPTIMIZELY",t);var s=function(f){var l=f.configObj,d=f.userId,R=f.userAttributes,m=f.clientEngine,V=f.clientVersion,j=f.eventKey,$=f.eventTags,ne=we(l,j),te=$?nt($,Pe):null,se=$?it($,Pe):null;return{type:"conversion",timestamp:K.currentTimestamp(),uuid:K.uuid(),user:{id:d,attributes:ft(l,R)},context:{accountId:l.accountId,projectId:l.projectId,revision:l.revision,clientName:m,clientVersion:V,anonymizeIP:l.anonymizeIP||!1,botFiltering:l.botFiltering},event:{id:ne,key:j},revenue:te,value:se,tags:$}}({eventKey:e,eventTags:i=this.filterEmptyValues(i),userId:t,userAttributes:n,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:o});this.logger.log(a.INFO,u.TRACK_EVENT,"OPTIMIZELY",e,t),this.eventProcessor.process(s),this.emitNotificationCenterTrack(e,t,n,i)}catch(f){this.logger.log(a.ERROR,f.message),this.errorHandler.handleError(f),this.logger.log(a.ERROR,u.NOT_TRACKING_USER,"OPTIMIZELY",t)}},r.prototype.emitNotificationCenterTrack=function(e,t,n,i){try{var o=this.projectConfigManager.getConfig();if(!o)return;var s=yt({attributes:n,clientEngine:this.clientEngine,clientVersion:this.clientVersion,configObj:o,eventKey:e,eventTags:i,logger:this.logger,userId:t});this.notificationCenter.sendNotifications(_.TRACK,{eventKey:e,userId:t,attributes:n,eventTags:i,logEvent:s})}catch(f){this.logger.log(a.ERROR,f.message),this.errorHandler.handleError(f)}},r.prototype.getVariation=function(e,t,n){try{if(!this.isValidInstance())return this.logger.log(a.ERROR,u.INVALID_OBJECT,"OPTIMIZELY","getVariation"),null;try{if(!this.validateInputs({experiment_key:e,user_id:t},n))return null;var i=this.projectConfigManager.getConfig();if(!i)return null;var o=i.experimentKeyMap[e];if(!o)return this.logger.log(a.DEBUG,E.INVALID_EXPERIMENT_KEY,"OPTIMIZELY",e),null;var s=this.decisionService.getVariation(i,o,this.createUserContext(t,n)).result,f=(l=i,d=o.id,l.experimentFeatureMap.hasOwnProperty(d)?I.FEATURE_TEST:I.AB_TEST);return this.notificationCenter.sendNotifications(_.DECISION,{type:f,userId:t,attributes:n||{},decisionInfo:{experimentKey:e,variationKey:s}}),s}catch(R){return this.logger.log(a.ERROR,R.message),this.errorHandler.handleError(R),null}}catch(R){return this.logger.log(a.ERROR,R.message),this.errorHandler.handleError(R),null}var l,d},r.prototype.setForcedVariation=function(e,t,n){if(!this.validateInputs({experiment_key:e,user_id:t}))return!1;var i=this.projectConfigManager.getConfig();if(!i)return!1;try{return this.decisionService.setForcedVariation(i,e,t,n)}catch(o){return this.logger.log(a.ERROR,o.message),this.errorHandler.handleError(o),!1}},r.prototype.getForcedVariation=function(e,t){if(!this.validateInputs({experiment_key:e,user_id:t}))return null;var n=this.projectConfigManager.getConfig();if(!n)return null;try{return this.decisionService.getForcedVariation(n,e,t).result}catch(i){return this.logger.log(a.ERROR,i.message),this.errorHandler.handleError(i),null}},r.prototype.validateInputs=function(e,t,n){try{if(e.hasOwnProperty("user_id")){var i=e.user_id;if(typeof i!="string"||i===null||i==="undefined")throw new Error((0,h.sprintf)(E.INVALID_INPUT_FORMAT,"OPTIMIZELY","user_id"));delete e.user_id}return Object.keys(e).forEach(function(o){if(!rt(e[o]))throw new Error((0,h.sprintf)(E.INVALID_INPUT_FORMAT,"OPTIMIZELY",o))}),t&&function(o){if(typeof o!="object"||Array.isArray(o)||o===null)throw new Error((0,h.sprintf)(E.INVALID_ATTRIBUTES,"ATTRIBUTES_VALIDATOR"));Object.keys(o).forEach(function(s){if(o[s]===void 0)throw new Error((0,h.sprintf)(E.UNDEFINED_ATTRIBUTE,"ATTRIBUTES_VALIDATOR",s))})}(t),n&&function(o){if(typeof o!="object"||Array.isArray(o)||o===null)throw new Error((0,h.sprintf)(E.INVALID_EVENT_TAGS,"EVENT_TAGS_VALIDATOR"))}(n),!0}catch(o){return this.logger.log(a.ERROR,o.message),this.errorHandler.handleError(o),!1}},r.prototype.notActivatingExperiment=function(e,t){return this.logger.log(a.INFO,u.NOT_ACTIVATING_USER,"OPTIMIZELY",t,e),null},r.prototype.filterEmptyValues=function(e){for(var t in e)!e.hasOwnProperty(t)||e[t]!==null&&e[t]!==void 0||delete e[t];return e},r.prototype.isFeatureEnabled=function(e,t,n){try{if(!this.isValidInstance())return this.logger.log(a.ERROR,u.INVALID_OBJECT,"OPTIMIZELY","isFeatureEnabled"),!1;if(!this.validateInputs({feature_key:e,user_id:t},n))return!1;var i=this.projectConfigManager.getConfig();if(!i)return!1;var o=Ce(i,e,this.logger);if(!o)return!1;var s={},f=this.createUserContext(t,n),l=this.decisionService.getVariationForFeature(i,o,f).result,d=l.decisionSource,R=Ve(l),m=be(l),V=Ue(l);d===F.FEATURE_TEST&&(s={experimentKey:R,variationKey:m}),(d===F.FEATURE_TEST||d===F.ROLLOUT&&Xe(i))&&this.sendImpressionEvent(l,o.key,t,V,n),V===!0?this.logger.log(a.INFO,u.FEATURE_ENABLED_FOR_USER,"OPTIMIZELY",e,t):(this.logger.log(a.INFO,u.FEATURE_NOT_ENABLED_FOR_USER,"OPTIMIZELY",e,t),V=!1);var j={featureKey:e,featureEnabled:V,source:l.decisionSource,sourceInfo:s};return this.notificationCenter.sendNotifications(_.DECISION,{type:I.FEATURE,userId:t,attributes:n||{},decisionInfo:j}),V}catch($){return this.logger.log(a.ERROR,$.message),this.errorHandler.handleError($),!1}},r.prototype.getEnabledFeatures=function(e,t){var n=this;try{var i=[];if(!this.isValidInstance())return this.logger.log(a.ERROR,u.INVALID_OBJECT,"OPTIMIZELY","getEnabledFeatures"),i;if(!this.validateInputs({user_id:e}))return i;var o=this.projectConfigManager.getConfig();return o&&(0,h.objectValues)(o.featureKeyMap).forEach(function(s){n.isFeatureEnabled(s.key,e,t)&&i.push(s.key)}),i}catch(s){return this.logger.log(a.ERROR,s.message),this.errorHandler.handleError(s),[]}},r.prototype.getFeatureVariable=function(e,t,n,i){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,null,n,i):(this.logger.log(a.ERROR,u.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariable"),null)}catch(o){return this.logger.log(a.ERROR,o.message),this.errorHandler.handleError(o),null}},r.prototype.getFeatureVariableForType=function(e,t,n,i,o){if(!this.validateInputs({feature_key:e,variable_key:t,user_id:i},o))return null;var s=this.projectConfigManager.getConfig();if(!s)return null;var f=Ce(s,e,this.logger);if(!f)return null;var l=function($,ne,te,se){var ce=$.featureKeyMap[ne];if(!ce)return se.log(a.ERROR,E.FEATURE_NOT_IN_DATAFILE,ee,ne),null;var ue=ce.variableKeyMap[te];return ue||(se.log(a.ERROR,E.VARIABLE_KEY_NOT_IN_DATAFILE,ee,te,ne),null)}(s,e,t,this.logger);if(!l)return null;if(n&&l.type!==n)return this.logger.log(a.WARNING,u.VARIABLE_REQUESTED_WITH_WRONG_TYPE,"OPTIMIZELY",n,l.type),null;var d=this.createUserContext(i,o),R=this.decisionService.getVariationForFeature(s,f,d).result,m=Ue(R),V=this.getFeatureVariableValueFromVariation(e,m,R.variation,l,i),j={};return R.decisionSource===F.FEATURE_TEST&&R.experiment!==null&&R.variation!==null&&(j={experimentKey:R.experiment.key,variationKey:R.variation.key}),this.notificationCenter.sendNotifications(_.DECISION,{type:I.FEATURE_VARIABLE,userId:i,attributes:o||{},decisionInfo:{featureKey:e,featureEnabled:m,source:R.decisionSource,variableKey:t,variableValue:V,variableType:l.type,sourceInfo:j}}),V},r.prototype.getFeatureVariableValueFromVariation=function(e,t,n,i,o){var s=this.projectConfigManager.getConfig();if(!s)return null;var f=i.defaultValue;if(n!==null){var l=function(d,R,m,V){if(!R||!m)return null;if(!d.variationVariableUsageMap.hasOwnProperty(m.id))return V.log(a.ERROR,E.VARIATION_ID_NOT_IN_DATAFILE_NO_EXPERIMENT,ee,m.id),null;var j=d.variationVariableUsageMap[m.id][R.id];return j?j.value:null}(s,i,n,this.logger);l!==null?t?(f=l,this.logger.log(a.INFO,u.USER_RECEIVED_VARIABLE_VALUE,"OPTIMIZELY",f,i.key,e)):this.logger.log(a.INFO,u.FEATURE_NOT_ENABLED_RETURN_DEFAULT_VARIABLE_VALUE,"OPTIMIZELY",e,o,f):this.logger.log(a.INFO,u.VARIABLE_NOT_USED_RETURN_DEFAULT_VARIABLE_VALUE,"OPTIMIZELY",i.key,n.key)}else this.logger.log(a.INFO,u.USER_RECEIVED_DEFAULT_VARIABLE_VALUE,"OPTIMIZELY",o,i.key,e);return function(d,R,m){var V;switch(R){case A.BOOLEAN:d!=="true"&&d!=="false"?(m.log(a.ERROR,E.UNABLE_TO_CAST_VALUE,ee,d,R),V=null):V=d==="true";break;case A.INTEGER:V=parseInt(d,10),isNaN(V)&&(m.log(a.ERROR,E.UNABLE_TO_CAST_VALUE,ee,d,R),V=null);break;case A.DOUBLE:V=parseFloat(d),isNaN(V)&&(m.log(a.ERROR,E.UNABLE_TO_CAST_VALUE,ee,d,R),V=null);break;case A.JSON:try{V=JSON.parse(d)}catch{m.log(a.ERROR,E.UNABLE_TO_CAST_VALUE,ee,d,R),V=null}break;default:V=d}return V}(f,i.type,this.logger)},r.prototype.getFeatureVariableBoolean=function(e,t,n,i){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,A.BOOLEAN,n,i):(this.logger.log(a.ERROR,u.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariableBoolean"),null)}catch(o){return this.logger.log(a.ERROR,o.message),this.errorHandler.handleError(o),null}},r.prototype.getFeatureVariableDouble=function(e,t,n,i){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,A.DOUBLE,n,i):(this.logger.log(a.ERROR,u.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariableDouble"),null)}catch(o){return this.logger.log(a.ERROR,o.message),this.errorHandler.handleError(o),null}},r.prototype.getFeatureVariableInteger=function(e,t,n,i){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,A.INTEGER,n,i):(this.logger.log(a.ERROR,u.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariableInteger"),null)}catch(o){return this.logger.log(a.ERROR,o.message),this.errorHandler.handleError(o),null}},r.prototype.getFeatureVariableString=function(e,t,n,i){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,A.STRING,n,i):(this.logger.log(a.ERROR,u.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariableString"),null)}catch(o){return this.logger.log(a.ERROR,o.message),this.errorHandler.handleError(o),null}},r.prototype.getFeatureVariableJSON=function(e,t,n,i){try{return this.isValidInstance()?this.getFeatureVariableForType(e,t,A.JSON,n,i):(this.logger.log(a.ERROR,u.INVALID_OBJECT,"OPTIMIZELY","getFeatureVariableJSON"),null)}catch(o){return this.logger.log(a.ERROR,o.message),this.errorHandler.handleError(o),null}},r.prototype.getAllFeatureVariables=function(e,t,n){var i=this;try{if(!this.isValidInstance())return this.logger.log(a.ERROR,u.INVALID_OBJECT,"OPTIMIZELY","getAllFeatureVariables"),null;if(!this.validateInputs({feature_key:e,user_id:t},n))return null;var o=this.projectConfigManager.getConfig();if(!o)return null;var s=Ce(o,e,this.logger);if(!s)return null;var f=this.createUserContext(t,n),l=this.decisionService.getVariationForFeature(o,s,f).result,d=Ue(l),R={};s.variables.forEach(function(V){R[V.key]=i.getFeatureVariableValueFromVariation(e,d,l.variation,V,t)});var m={};return l.decisionSource===F.FEATURE_TEST&&l.experiment!==null&&l.variation!==null&&(m={experimentKey:l.experiment.key,variationKey:l.variation.key}),this.notificationCenter.sendNotifications(_.DECISION,{type:I.ALL_FEATURE_VARIABLES,userId:t,attributes:n||{},decisionInfo:{featureKey:e,featureEnabled:d,source:l.decisionSource,variableValues:R,sourceInfo:m}}),R}catch(V){return this.logger.log(a.ERROR,V.message),this.errorHandler.handleError(V),null}},r.prototype.getOptimizelyConfig=function(){try{return this.projectConfigManager.getConfig()?this.projectConfigManager.getOptimizelyConfig():null}catch(e){return this.logger.log(a.ERROR,e.message),this.errorHandler.handleError(e),null}},r.prototype.close=function(){var e=this;try{var t=this.eventProcessor.stop();return this.disposeOnUpdate&&(this.disposeOnUpdate(),this.disposeOnUpdate=null),this.projectConfigManager&&this.projectConfigManager.stop(),Object.keys(this.readyTimeouts).forEach(function(n){var i=e.readyTimeouts[n];clearTimeout(i.readyTimeout),i.onClose()}),this.readyTimeouts={},t.then(function(){return{success:!0}},function(n){return{success:!1,reason:String(n)}})}catch(n){return this.logger.log(a.ERROR,n.message),this.errorHandler.handleError(n),Promise.resolve({success:!1,reason:String(n)})}},r.prototype.onReady=function(e){var t,n,i=this;typeof e=="object"&&e!==null&&e.timeout!==void 0&&(t=e.timeout),K.isSafeInteger(t)||(t=3e4);var o=new Promise(function(l){n=l}),s=this.nextReadyTimeoutId;this.nextReadyTimeoutId++;var f=setTimeout(function(){delete i.readyTimeouts[s],n({success:!1,reason:(0,h.sprintf)("onReady timeout expired after %s ms",t)})},t);return this.readyTimeouts[s]={readyTimeout:f,onClose:function(){n({success:!1,reason:"Instance closed"})}},this.readyPromise.then(function(){clearTimeout(f),delete i.readyTimeouts[s],n({success:!0})}),Promise.race([this.readyPromise,o])},r.prototype.createUserContext=function(e,t){return this.validateInputs({user_id:e},t)?new q({optimizely:this,userId:e,attributes:t}):null},r.prototype.decide=function(e,t,n){var i,o,s,f,l=this;n===void 0&&(n=[]);var d,R=e.getUserId(),m=e.getAttributes(),V=this.projectConfigManager.getConfig(),j=[];if(!this.isValidInstance()||!V)return this.logger.log(a.INFO,u.INVALID_OBJECT,"OPTIMIZELY","decide"),H(t,e,[k.SDK_NOT_READY]);var $=V.featureKeyMap[t];if(!$)return this.logger.log(a.ERROR,E.FEATURE_NOT_IN_DATAFILE,"OPTIMIZELY",t),H(t,e,[(0,h.sprintf)(k.FLAG_KEY_INVALID,t)]);var ne=this.getAllDecideOptions(n),te=this.decisionService.findValidatedForcedDecision(V,e,t);j.push.apply(j,te.reasons);var se=te.result;if(se)d={experiment:null,variation:se,decisionSource:F.FEATURE_TEST};else{var ce=this.decisionService.getVariationForFeature(V,$,e,ne);j.push.apply(j,ce.reasons),d=ce.result}var ue=d.decisionSource,le=(o=(i=d.experiment)===null||i===void 0?void 0:i.key)!==null&&o!==void 0?o:null,Ie=(f=(s=d.variation)===null||s===void 0?void 0:s.key)!==null&&f!==void 0?f:null,de=Ue(d);de===!0?this.logger.log(a.INFO,u.FEATURE_ENABLED_FOR_USER,"OPTIMIZELY",t,R):this.logger.log(a.INFO,u.FEATURE_NOT_ENABLED_FOR_USER,"OPTIMIZELY",t,R);var ke={},ct=!1;ne[G.EXCLUDE_VARIABLES]||$.variables.forEach(function(Te){ke[Te.key]=l.getFeatureVariableValueFromVariation(t,de,d.variation,Te,R)}),!ne[G.DISABLE_DECISION_EVENT]&&(ue===F.FEATURE_TEST||ue===F.ROLLOUT&&Xe(V))&&(this.sendImpressionEvent(d,t,R,de,m),ct=!0);var xe=[];ne[G.INCLUDE_REASONS]&&(xe=j.map(function(Te){return h.sprintf.apply(void 0,M([Te[0]],Te.slice(1)))}));var bt={flagKey:t,enabled:de,variationKey:Ie,ruleKey:le,variables:ke,reasons:xe,decisionEventDispatched:ct};return this.notificationCenter.sendNotifications(_.DECISION,{type:I.FLAG,userId:R,attributes:m,decisionInfo:bt}),{variationKey:Ie,enabled:de,variables:ke,ruleKey:le,flagKey:t,userContext:e,reasons:xe}},r.prototype.getAllDecideOptions=function(e){var t=this,n=v({},this.defaultDecideOptions);return Array.isArray(e)?e.forEach(function(i){G[i]?n[i]=!0:t.logger.log(a.WARNING,u.UNRECOGNIZED_DECIDE_OPTION,"OPTIMIZELY",i)}):this.logger.log(a.DEBUG,u.INVALID_DECIDE_OPTIONS,"OPTIMIZELY"),n},r.prototype.decideForKeys=function(e,t,n){var i=this;n===void 0&&(n=[]);var o={};if(!this.isValidInstance())return this.logger.log(a.ERROR,u.INVALID_OBJECT,"OPTIMIZELY","decideForKeys"),o;if(t.length===0)return o;var s=this.getAllDecideOptions(n);return t.forEach(function(f){var l=i.decide(e,f,n);s[G.ENABLED_FLAGS_ONLY]&&!l.enabled||(o[f]=l)}),o},r.prototype.decideAll=function(e,t){t===void 0&&(t=[]);var n=this.projectConfigManager.getConfig();if(!this.isValidInstance()||!n)return this.logger.log(a.ERROR,u.INVALID_OBJECT,"OPTIMIZELY","decideAll"),{};var i=Object.keys(n.featureKeyMap);return this.decideForKeys(e,i,t)},r}(),Nt=c(function(r){return!(typeof r!="number"||!K.isSafeInteger(r))&&r>=1},"tt"),At=c(function(r){return!(typeof r!="number"||!K.isSafeInteger(r))&&r>0},"rt"),mt=function(){function r(e){var t=this;this.logger=e.logger,this.errorHandler=e.errorHandler,this.notificationListeners={},(0,h.objectValues)(_).forEach(function(n){t.notificationListeners[n]=[]}),this.listenerId=1}return c(r,"e"),r.prototype.addNotificationListener=function(e,t){try{if(!((0,h.objectValues)(_).indexOf(e)>-1))return-1;this.notificationListeners[e]||(this.notificationListeners[e]=[]);var n=!1;if((this.notificationListeners[e]||[]).forEach(function(o){o.callback!==t||(n=!0)}),n)return-1;this.notificationListeners[e].push({id:this.listenerId,callback:t});var i=this.listenerId;return this.listenerId+=1,i}catch(o){return this.logger.log(a.ERROR,o.message),this.errorHandler.handleError(o),-1}},r.prototype.removeNotificationListener=function(e){var t=this;try{var n,i;if(Object.keys(this.notificationListeners).some(function(o){return(t.notificationListeners[o]||[]).every(function(s,f){return s.id!==e||(n=f,i=o,!1)}),n!==void 0&&i!==void 0}),n!==void 0&&i!==void 0)return this.notificationListeners[i].splice(n,1),!0}catch(o){this.logger.log(a.ERROR,o.message),this.errorHandler.handleError(o)}return!1},r.prototype.clearAllNotificationListeners=function(){var e=this;try{(0,h.objectValues)(_).forEach(function(t){e.notificationListeners[t]=[]})}catch(t){this.logger.log(a.ERROR,t.message),this.errorHandler.handleError(t)}},r.prototype.clearNotificationListeners=function(e){try{this.notificationListeners[e]=[]}catch(t){this.logger.log(a.ERROR,t.message),this.errorHandler.handleError(t)}},r.prototype.sendNotifications=function(e,t){var n=this;try{(this.notificationListeners[e]||[]).forEach(function(i){var o=i.callback;try{o(t)}catch(s){n.logger.log(a.ERROR,u.NOTIFICATION_LISTENER_EXCEPTION,"NOTIFICATION_CENTER",e,s.message)}})}catch(i){this.logger.log(a.ERROR,i.message),this.errorHandler.handleError(i)}},r}(),Lt={createEventProcessor:function(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];return new(C.LogTierV1EventProcessor.bind.apply(C.LogTierV1EventProcessor,M([void 0],r)))},LocalStoragePendingEventsDispatcher:C.LocalStoragePendingEventsDispatcher};function Dt(r,e,t,n){var i={sdkKey:r};if((n===void 0||typeof n=="object"&&n!==null)&&K.assign(i,n),t){var o=ze({datafile:t,jsonSchemaValidator:void 0,logger:e}),s=o.configObj,f=o.error;f&&e.error(f),s&&(i.datafile=Ye(s))}return new y.z(i)}c(Dt,"ot");var _e=(0,O.getLogger)();(0,O.setLogHandler)(B()),(0,O.setLogLevel)(O.LogLevel.INFO);var Fe=!1,Ut=c(function(r){try{r.errorHandler&&(0,O.setErrorHandler)(r.errorHandler),r.logger&&((0,O.setLogHandler)(r.logger),(0,O.setLogLevel)(O.LogLevel.NOTSET)),r.logLevel!==void 0&&(0,O.setLogLevel)(r.logLevel);try{ge(r),r.isValidInstance=!0}catch(R){_e.error(R),r.isValidInstance=!1}var e=void 0;r.eventDispatcher==null?(e=new C.LocalStoragePendingEventsDispatcher({eventDispatcher:S}),Fe||(e.sendPendingEvents(),Fe=!0)):e=r.eventDispatcher;var t=r.eventBatchSize,n=r.eventFlushInterval;Nt(r.eventBatchSize)||(_e.warn("Invalid eventBatchSize %s, defaulting to %s",r.eventBatchSize,10),t=10),At(r.eventFlushInterval)||(_e.warn("Invalid eventFlushInterval %s, defaulting to %s",r.eventFlushInterval,1e3),n=1e3);var i=(0,O.getErrorHandler)(),o=new mt({logger:_e,errorHandler:i}),s={dispatcher:e,flushInterval:n,batchSize:t,maxQueueSize:r.eventMaxQueueSize||1e4,notificationCenter:o},f=v(v({clientEngine:"javascript-sdk"},r),{eventProcessor:Lt.createEventProcessor(s),logger:_e,errorHandler:i,datafileManager:r.sdkKey?Dt(r.sdkKey,_e,r.datafile,r.datafileOptions):void 0,notificationCenter:o}),l=new Tt(f);try{if(typeof window.addEventListener=="function"){var d="onpagehide"in window?"pagehide":"unload";window.addEventListener(d,function(){l.close()},!1)}}catch(R){_e.error(u.UNABLE_TO_ATTACH_UNLOAD,"INDEX_BROWSER",R.message)}return l}catch(R){return _e.error(R),null}},"ut"),St=c(function(){Fe=!1},"lt"),Ct={logging:z,errorHandler:Ne,eventDispatcher:S,enums:Z,setLogger:O.setLogHandler,setLogLevel:O.setLogLevel,createInstance:Ut,__internalResetRetryState:St,OptimizelyDecideOption:G};const Vt=Ct},59753:(X,g,U)=>{"use strict";U.d(g,{f:()=>Oe,on:()=>he});function O(){if(!(this instanceof O))return new O;this.size=0,this.uid=0,this.selectors=[],this.selectorObjects={},this.indexes=Object.create(this.indexes),this.activeIndexes=[]}c(O,"SelectorSet");var P=window.document.documentElement,C=P.matches||P.webkitMatchesSelector||P.mozMatchesSelector||P.oMatchesSelector||P.msMatchesSelector;O.prototype.matchesSelector=function(S,x){return C.call(S,x)},O.prototype.querySelectorAll=function(S,x){return x.querySelectorAll(S)},O.prototype.indexes=[];var T=/^#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/g;O.prototype.indexes.push({name:"ID",selector:c(function(x){var B;if(B=x.match(T))return B[0].slice(1)},"matchIdSelector"),element:c(function(x){if(x.id)return[x.id]},"getElementId")});var h=/^\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/g;O.prototype.indexes.push({name:"CLASS",selector:c(function(x){var B;if(B=x.match(h))return B[0].slice(1)},"matchClassSelector"),element:c(function(x){var B=x.className;if(B){if(typeof B=="string")return B.split(/\s/);if(typeof B=="object"&&"baseVal"in B)return B.baseVal.split(/\s/)}},"getElementClassNames")});var N=/^((?:[\w\u00c0-\uFFFF\-]|\\.)+)/g;O.prototype.indexes.push({name:"TAG",selector:c(function(x){var B;if(B=x.match(N))return B[0].toUpperCase()},"matchTagSelector"),element:c(function(x){return[x.nodeName.toUpperCase()]},"getElementTagName")}),O.prototype.indexes.default={name:"UNIVERSAL",selector:function(){return!0},element:function(){return[!0]}};var L;typeof window.Map=="function"?L=window.Map:L=function(){function S(){this.map={}}return c(S,"Map"),S.prototype.get=function(x){return this.map[x+" "]},S.prototype.set=function(x,B){this.map[x+" "]=B},S}();var y=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g;function v(S,x){S=S.slice(0).concat(S.default);var B=S.length,Y,G,z,H,q=x,W,J,Q=[];do if(y.exec(""),(z=y.exec(q))&&(q=z[3],z[2]||!q)){for(Y=0;Y<B;Y++)if(J=S[Y],W=J.selector(z[1])){for(G=Q.length,H=!1;G--;)if(Q[G].index===J&&Q[G].key===W){H=!0;break}H||Q.push({index:J,key:W});break}}while(z);return Q}c(v,"parseSelectorIndexes");function M(S,x){var B,Y,G;for(B=0,Y=S.length;B<Y;B++)if(G=S[B],x.isPrototypeOf(G))return G}c(M,"findByPrototype"),O.prototype.logDefaultIndexUsed=function(){},O.prototype.add=function(S,x){var B,Y,G,z,H,q,W,J,Q=this.activeIndexes,ie=this.selectors,K=this.selectorObjects;if(typeof S=="string"){for(B={id:this.uid++,selector:S,data:x},K[B.id]=B,W=v(this.indexes,S),Y=0;Y<W.length;Y++)J=W[Y],z=J.key,G=J.index,H=M(Q,G),H||(H=Object.create(G),H.map=new L,Q.push(H)),G===this.indexes.default&&this.logDefaultIndexUsed(B),q=H.map.get(z),q||(q=[],H.map.set(z,q)),q.push(B);this.size++,ie.push(S)}},O.prototype.remove=function(S,x){if(typeof S=="string"){var B,Y,G,z,H,q,W,J,Q=this.activeIndexes,ie=this.selectors=[],K=this.selectorObjects,ee={},ve=arguments.length===1;for(B=v(this.indexes,S),G=0;G<B.length;G++)for(Y=B[G],z=Q.length;z--;)if(q=Q[z],Y.index.isPrototypeOf(q)){if(W=q.map.get(Y.key),W)for(H=W.length;H--;)J=W[H],J.selector===S&&(ve||J.data===x)&&(W.splice(H,1),ee[J.id]=!0);break}for(G in ee)delete K[G],this.size--;for(G in K)ie.push(K[G].selector)}};function a(S,x){return S.id-x.id}c(a,"sortById"),O.prototype.queryAll=function(S){if(!this.selectors.length)return[];var x={},B=[],Y=this.querySelectorAll(this.selectors.join(", "),S),G,z,H,q,W,J,Q,ie;for(G=0,H=Y.length;G<H;G++)for(W=Y[G],J=this.matches(W),z=0,q=J.length;z<q;z++)ie=J[z],x[ie.id]?Q=x[ie.id]:(Q={id:ie.id,selector:ie.selector,data:ie.data,elements:[]},x[ie.id]=Q,B.push(Q)),Q.elements.push(W);return B.sort(a)},O.prototype.matches=function(S){if(!S)return[];var x,B,Y,G,z,H,q,W,J,Q,ie,K=this.activeIndexes,ee={},ve=[];for(x=0,G=K.length;x<G;x++)if(q=K[x],W=q.element(S),W){for(B=0,z=W.length;B<z;B++)if(J=q.map.get(W[B]))for(Y=0,H=J.length;Y<H;Y++)Q=J[Y],ie=Q.id,!ee[ie]&&this.matchesSelector(S,Q.selector)&&(ee[ie]=!0,ve.push(Q))}return ve.sort(a)};var E={},u={},p=new WeakMap,_=new WeakMap,I=new WeakMap,F=Object.getOwnPropertyDescriptor(Event.prototype,"currentTarget");function b(S,x,B){var Y=S[x];return S[x]=function(){return B.apply(S,arguments),Y.apply(S,arguments)},S}c(b,"before");function A(S,x,B){var Y=[],G=x;do{if(G.nodeType!==1)break;var z=S.matches(G);if(z.length){var H={node:G,observers:z};B?Y.unshift(H):Y.push(H)}}while(G=G.parentElement);return Y}c(A,"dist_matches");function D(){p.set(this,!0)}c(D,"trackPropagation");function k(){p.set(this,!0),_.set(this,!0)}c(k,"trackImmediate");function Z(){return I.get(this)||null}c(Z,"getCurrentTarget");function re(S,x){!F||Object.defineProperty(S,"currentTarget",{configurable:!0,enumerable:!0,get:x||F.get})}c(re,"defineCurrentTarget");function Ee(S){try{return S.eventPhase,!0}catch{return!1}}c(Ee,"canDispatch");function ge(S){if(!!Ee(S)){var x=S.eventPhase===1?u:E,B=x[S.type];if(!!B){var Y=A(B,S.target,S.eventPhase===1);if(!!Y.length){b(S,"stopPropagation",D),b(S,"stopImmediatePropagation",k),re(S,Z);for(var G=0,z=Y.length;G<z&&!p.get(S);G++){var H=Y[G];I.set(S,H.node);for(var q=0,W=H.observers.length;q<W&&!_.get(S);q++)H.observers[q].data.call(H.node,S)}I.delete(S),re(S)}}}}c(ge,"dispatch");function he(S,x,B){var Y=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{},G=!!Y.capture,z=G?u:E,H=z[S];H||(H=new O,z[S]=H,document.addEventListener(S,ge,G)),H.add(x,B)}c(he,"on");function Ne(S,x,B){var Y=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{},G=!!Y.capture,z=G?u:E,H=z[S];!H||(H.remove(x,B),!H.size&&(delete z[S],document.removeEventListener(S,ge,G)))}c(Ne,"off");function Oe(S,x,B){return S.dispatchEvent(new CustomEvent(x,{bubbles:!0,cancelable:!0,detail:B}))}c(Oe,"fire")},58053:X=>{(function(){var g=this;function U(T,h){for(var N=T.length,L=h^N,y=0,v;N>=4;)v=T.charCodeAt(y)&255|(T.charCodeAt(++y)&255)<<8|(T.charCodeAt(++y)&255)<<16|(T.charCodeAt(++y)&255)<<24,v=(v&65535)*1540483477+(((v>>>16)*1540483477&65535)<<16),v^=v>>>24,v=(v&65535)*1540483477+(((v>>>16)*1540483477&65535)<<16),L=(L&65535)*1540483477+(((L>>>16)*1540483477&65535)<<16)^v,N-=4,++y;switch(N){case 3:L^=(T.charCodeAt(y+2)&255)<<16;case 2:L^=(T.charCodeAt(y+1)&255)<<8;case 1:L^=T.charCodeAt(y)&255,L=(L&65535)*1540483477+(((L>>>16)*1540483477&65535)<<16)}return L^=L>>>13,L=(L&65535)*1540483477+(((L>>>16)*1540483477&65535)<<16),L^=L>>>15,L>>>0}c(U,"MurmurHashV2");function O(T,h){var N,L,y,v,M,a,E,u,p,_;for(N=T.length&3,L=T.length-N,y=h,M=3432918353,E=461845907,_=0;_<L;)p=T.charCodeAt(_)&255|(T.charCodeAt(++_)&255)<<8|(T.charCodeAt(++_)&255)<<16|(T.charCodeAt(++_)&255)<<24,++_,p=(p&65535)*M+(((p>>>16)*M&65535)<<16)&4294967295,p=p<<15|p>>>17,p=(p&65535)*E+(((p>>>16)*E&65535)<<16)&4294967295,y^=p,y=y<<13|y>>>19,v=(y&65535)*5+(((y>>>16)*5&65535)<<16)&4294967295,y=(v&65535)+27492+(((v>>>16)+58964&65535)<<16);switch(p=0,N){case 3:p^=(T.charCodeAt(_+2)&255)<<16;case 2:p^=(T.charCodeAt(_+1)&255)<<8;case 1:p^=T.charCodeAt(_)&255,p=(p&65535)*M+(((p>>>16)*M&65535)<<16)&4294967295,p=p<<15|p>>>17,p=(p&65535)*E+(((p>>>16)*E&65535)<<16)&4294967295,y^=p}return y^=T.length,y^=y>>>16,y=(y&65535)*2246822507+(((y>>>16)*2246822507&65535)<<16)&4294967295,y^=y>>>13,y=(y&65535)*3266489909+(((y>>>16)*3266489909&65535)<<16)&4294967295,y^=y>>>16,y>>>0}c(O,"MurmurHashV3");var P=O;if(P.v2=U,P.v3=O,!0)X.exports=P;else var C})()}}]);})();

//# sourceMappingURL=vendors-node_modules_optimizely_optimizely-sdk_dist_optimizely_browser_es_min_js-node_modules-089adc-4231ce11245b.js.map